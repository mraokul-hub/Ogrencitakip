<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bilge Takip - Ã–ÄŸrenci Paneli</title>
    <link rel="icon" href="Designer.jpg" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* --- TEMEL STÄ°LLER --- */
        .hidden { display: none !important; visibility: hidden !important; opacity: 0 !important; }
        :root { --primary: #009688; --primary-dark: #004d40; --warning: #f59e0b; --danger: #ef4444; --bg-gradient: linear-gradient(135deg, #e0f2f1 0%, #f0fdf4 100%); --text-main: #0f172a; --text-sub: #475569; --bottom-nav-height: 90px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text !important; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-gradient); margin: 0; padding: 15px; min-height: 100vh; color: var(--text-main); padding-bottom: 130px; overflow-x: hidden; }
        
        /* --- KARTLAR & UI --- */
        .container { width: 100%; max-width: 480px; margin: 0 auto; }
        .card { background: #ffffff; border-radius: 30px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); padding: 24px; margin-bottom: 24px; position: relative; border: 1px solid #f1f5f9; }
        h2, h3 { margin: 0 0 10px 0; color: var(--primary-dark); letter-spacing: -0.5px; }
        h4 { margin: 0 0 20px 0; font-weight: 800; color: var(--text-sub); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; }
        
        /* --- GÄ°RÄ°Å EKRANI --- */
        .auth-tabs { display: flex; background: #f1f5f9; padding: 5px; border-radius: 18px; margin-bottom: 25px; }
        .auth-tab { flex: 1; text-align: center; padding: 12px; border-radius: 14px; font-weight: 700; color: var(--text-sub); cursor: pointer; transition: 0.3s; }
        .auth-tab.active { background: white; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .input-group { display: flex; gap: 15px; margin-top: 20px; }
        .input-modern { background: #f1f5f9; border: none; border-radius: 16px; padding: 15px; font-size: 1rem; font-weight: 700; width: 100%; text-align: center; outline: none; margin-bottom: 10px; }
        .input-modern:focus { box-shadow: 0 0 0 2px var(--primary); background: white; }
        
        /* --- BUTONLAR --- */
        button { cursor: pointer; border: none; font-family: inherit; transition: 0.2s; touch-action: manipulation; } 
        button:active { transform: scale(0.96); } 
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-action { width: 100%; padding: 18px; border-radius: 20px; font-size: 1.1rem; font-weight: 800; color: white; background: var(--primary); margin-top: 15px; }
        .btn-logout-header { background: #fee2e2; color: var(--danger); padding: 8px 12px; border-radius: 12px; font-weight: 700; font-size: 0.8rem; margin-left: 10px; border: 1px solid #fca5a5; }
        
        /* --- CHIPS & SEÃ‡Ä°MLER --- */
        .chips { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
        .chip-modern { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 25px; padding: 12px 24px; font-weight: 600; color: var(--text-sub); cursor: pointer; transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        .chip-modern.active { border-color: var(--primary); color: var(--primary); background: #f0fdf4; box-shadow: 0 0 0 2px rgba(0, 150, 136, 0.1); }
        
        /* --- POMODORO --- */
        .timer-display { font-size: 4.5rem; font-weight: 800; text-align: center; color: var(--primary); margin: 20px 0; line-height: 1; }
        .pomo-controls { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-pomo { padding: 15px 30px; border-radius: 16px; font-weight: 700; color: white; flex: 1; min-width: 120px; }
        .btn-timer-adj { width: 50px; height: 50px; border-radius: 15px; background: #e0f2f1; color: var(--primary-dark); font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        
        /* --- MAÄAZA --- */
        .store-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .store-card { background: white; border: 1px solid #e2e8f0; border-radius: 24px; padding: 20px; text-align: center; }
        .store-icon { font-size: 3rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; }
        .store-name { font-weight: 800; color: var(--text-main); display: block; margin-bottom: 5px; }
        .store-price { font-weight: 700; color: var(--warning); font-size: 0.9rem; margin-bottom: 15px; display: block; }
        .btn-store { background: #f1f5f9; color: var(--text-sub); padding: 12px; width: 100%; border-radius: 12px; font-weight: 700; }
        
        /* --- OTAÄ (KLAN) --- */
        .clan-card-modern { background: linear-gradient(135deg, #e0f2f1, #fff); border: 2px solid var(--primary); text-align: center; padding: 30px 20px; border-radius: 24px; }
        .clan-banner-modern { font-size: 4rem; margin-bottom: 10px; }
        .tore-box-modern { background: #fffbeb; border: 1px solid #fcd34d; padding: 20px; border-radius: 20px; margin-bottom: 20px; font-size: 0.95rem; color: #92400e; font-style: italic; text-align: left; }
        
        /* --- ALT MENÃœ & FOOTER --- */
        .app-footer { text-align: center; font-size: 0.8rem; color: var(--text-sub); padding: 20px 0; border-top: 1px solid rgba(0,0,0,0.05); margin-top: 30px; }
        .mobile-bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height); background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border-top: 1px solid rgba(178, 223, 219, 0.6); display: flex; justify-content: space-around; align-items: center; padding-bottom: 15px; z-index: 1000; box-shadow: 0 -5px 20px rgba(0, 150, 136, 0.08); border-top-left-radius: 20px; border-top-right-radius: 20px; overflow-x: auto; padding: 0 5px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; color: #94a3b8; background: none; border: none; cursor: pointer; transition: all 0.3s; flex: 1; height: 100%; padding: 5px 0; min-width: 60px; touch-action: manipulation; }
        .nav-icon { font-size: 1.6rem; margin-bottom: 6px; transition: transform 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: 800; }
        .nav-item.active .nav-icon { transform: translateY(-5px); }
        
        /* --- MODAL --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 77, 64, 0.6); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 30px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        
        /* --- PROGRESS BAR & LEVEL --- */
        .level-container { margin-top: 5px; width: 100%; }
        .xp-track { width: 100%; background: rgba(0, 0, 0, 0.1); height: 6px; border-radius: 10px; overflow: hidden; position: relative; margin-top: 4px; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); width: 0%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .rank-badge { font-size: 0.75rem; font-weight: 800; color: #fff; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 12px; margin-left: 6px; }
        
        /* --- BÄ°LGE BAYKUÅ (DÃœZELTÄ°LDÄ°: TÄ±klama Engeli KalktÄ±) --- */
        .wise-coach-container { 
            position: fixed; bottom: 100px; right: 10px; z-index: 999; 
            display: flex; flex-direction: column; align-items: flex-end; 
            pointer-events: none; /* KRÄ°TÄ°K: TÄ±klamalar arkaya geÃ§sin */
        }
        .wise-avatar, .coach-bubble {
            pointer-events: auto; /* Sadece bunlar tÄ±klanabilir olsun */
        }
        .wise-avatar { width: 65px; height: 65px; background: linear-gradient(135deg, #4f46e5, #9333ea); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); cursor: pointer; border: 3px solid #fff; position: relative; transition: transform 0.3s; }
        .coach-badge { position: absolute; top: 0; right: 0; background: #ef4444; color: white; font-size: 0.75rem; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; animation: pulseBadge 2s infinite; }
        .coach-bubble { background: white; padding: 15px 25px 15px 15px; border-radius: 20px 20px 4px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 10px; max-width: 250px; font-size: 0.9rem; color: var(--text-main); border: 2px solid #e0e7ff; opacity: 0; transform: translateY(20px) scale(0.9); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; position: absolute; bottom: 75px; right: 0; width: max-content; font-weight: 700; z-index: 1000; cursor: pointer; position: relative; }
        .coach-bubble.show { opacity: 1; transform: translateY(0) scale(1); }
        @keyframes excited { 0% { transform: scale(1) rotate(0deg); } 25% { transform: scale(1.1) rotate(-5deg); } 50% { transform: scale(1.1) rotate(5deg); } 75% { transform: scale(1.1) rotate(-5deg); } 100% { transform: scale(1) rotate(0deg); } }
        .owl-excited { animation: excited 0.8s infinite; }
        @keyframes pulseBadge { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .points-table { width:100%; border-collapse: collapse; margin-top:10px; font-size:0.85rem;} .points-table td { padding:8px; border-bottom:1px solid #eee; }
        .swal2-container { z-index: 10000 !important; }

        /* --- MOBÄ°L UYUMLULUK (RESPONSIVE) ZIRHI - GÃœNCELLENDÄ° --- */
        @media (max-width: 480px) {
            body { 
                padding: 10px; 
                padding-bottom: 130px; /* Hakan simgesi iÃ§in ekstra alan */
            }

            /* --- GENEL DOKUNMA HASSASÄ°YETÄ° --- */
            button, .btn-action, .chip-modern, .nav-item, .store-card {
                min-height: 48px; 
                touch-action: manipulation; 
            }

            /* MaÄŸaza ButonlarÄ±nÄ± GÃ¼Ã§lendir */
            .btn-store {
                padding: 15px !important; 
                font-size: 1rem !important;
                background: #e2e8f0; 
                color: var(--text-main);
                z-index: 10; 
                position: relative;
            }

            /* SeÃ§im KutucuklarÄ± */
            .chip-modern {
                padding: 12px 18px; 
                margin: 3px;
                font-size: 0.95rem;
                flex: 1 1 auto; 
                text-align: center;
            }

            .container { width: 100%; }
            .card { padding: 20px 15px; border-radius: 25px; margin-bottom: 15px; }
            
            /* --- YAZI BOYUTU DÃœZELTMELERÄ° --- */
            h2 { font-size: 1.4rem; }
            #userAvatar { font-size: 2.2rem !important; margin-right: 10px !important; }
            #stName { font-size: 1.1rem !important; }
            
            /* "RAKÄ°P BEKLENÄ°YOR" DÃœZELTMESÄ° (TaÅŸmayÄ± Ã¶nler) */
            .timer-display { font-size: 3rem; margin: 15px 0 !important; }
            .text-mode-timer { 
                font-size: 1.5rem !important; 
                line-height: 1.2; 
                margin: 10px 0; 
                word-wrap: break-word; 
            }
            
            /* Alt MenÃ¼ DÃ¼zeni */
            .mobile-bottom-nav { justify-content: space-between; padding: 0 5px; height: 80px; }
            .nav-item { min-width: auto; flex: 1; padding: 5px 0; }
            .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }
            .nav-item span { font-size: 0.65rem; display: block; font-weight: 600; }
            
            .modal-content { padding: 25px 20px; width: 95%; max-height: 85vh; }
            
            .store-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
            .store-card { padding: 15px 5px; }
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="container fade-in" id="mainContainer">
    <div id="authScreen" class="card" style="margin-top: 60px; text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 15px;">ğŸ›¡ï¸</div>
        <h2 id="authTitle">Bilge Takip</h2>
        <div class="auth-tabs">
            <div class="auth-tab active" id="tabLogin" onclick="switchAuthMode(true)">GÄ°RÄ°Å YAP</div>
            <div class="auth-tab" id="tabRegister" onclick="switchAuthMode(false)">KAYIT OL</div>
        </div>
        <div style="margin-bottom:20px; color:var(--text-sub); font-size:0.9rem;" id="authDesc">Maceraya devam etmek iÃ§in giriÅŸ yap.</div>
        <input type="text" id="regName" placeholder="Ad Soyad" class="input-modern hidden" style="margin-bottom:10px;">
        <input type="email" id="email" placeholder="E-Posta Adresi" class="input-modern" style="margin-bottom:10px;">
        <input type="password" id="password" placeholder="Åifre" class="input-modern">
        <button class="btn-action" onclick="handleLogin()" id="authBtn">GÄ°RÄ°Å YAP</button>
        <div id="authError" style="color:var(--danger); margin-top:15px; font-weight:600; display:none;"></div>
        <div class="app-footer">Â© 2025 Remzi<br><a href="mailto:yabguhakan2025@gmail.com" style="color:var(--primary); text-decoration:none; font-weight:bold;">yabguhakan2025@gmail.com</a></div>
    </div>

    <div id="dashboardScreen" class="hidden fade-in">
        <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:10px 20px; position: sticky; top: 10px; z-index: 900; background:rgba(255,255,255,0.98); backdrop-filter:blur(10px); border-bottom:3px solid var(--primary); border-radius: 20px;">
            <div style="display:flex; align-items:center;">
                <div id="userAvatar" style="font-size:2.8rem; margin-right:15px; filter:drop-shadow(0 4px 4px rgba(0,0,0,0.2)); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">ğŸ“</div>
                <div style="display:flex; flex-direction:column;">
                    <div style="font-size:0.8rem; color:var(--text-sub); font-weight:700;">HoÅŸ geldin,</div>
                    <div style="display:flex; align-items:center; flex-wrap:wrap; gap:5px;">
                        <span id="stName" style="color:var(--primary-dark); font-weight:800; font-size:1.1rem;">Ã–ÄŸrenci</span>
                        <span id="rankBadgeDisplay" class="rank-badge" style="background:linear-gradient(135deg, #f59e0b, #d97706); color:white; padding:3px 10px; border-radius:12px; font-size:0.75rem; box-shadow:0 2px 5px rgba(245, 158, 11, 0.3);">Ã‡Ä±rak (0 dk)</span>
                    </div>
                    <div class="level-container" style="width:120px; margin-top:5px;">
                        <div class="xp-track" style="height:4px;"><div class="xp-fill" id="xpProgressBar"></div></div>
                    </div>
                </div>
            </div>
            <div style="display:flex; align-items:center;">
                <button style="background:white; border:1px solid #e2e8f0; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; margin-right:10px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.05);" onclick="openProfileModal()">âš™ï¸</button>
                <button class="btn-logout-header" onclick="handleLogout()" style="height:40px;">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <div style="text-align:right; padding:0 15px; margin-bottom:10px; display:flex; justify-content:flex-end; gap:10px;">
             <span style="background:white; padding:5px 15px; border-radius:15px; font-weight:800; color:#6366f1; border:1px solid #e2e8f0;">âœ¨ <span id="stXP">0</span> Puan</span>
             <span style="background:white; padding:5px 15px; border-radius:15px; font-weight:800; color:var(--warning); border:1px solid #e2e8f0;">ğŸ’° <span id="stGold">0</span> AltÄ±n</span>
        </div>

        <div class="mobile-bottom-nav">
            <button class="nav-item active" onclick="switchTab('home', this)"><span class="nav-icon">ğŸ </span><span>GiriÅŸ</span></button>
            <button class="nav-item" onclick="switchTab('pomo', this)"><span class="nav-icon">â±ï¸</span><span>SayaÃ§</span></button>
            <button class="nav-item" onclick="switchTab('clan', this)"><span class="nav-icon">â›º</span><span>OtaÄŸ</span></button>
            <button class="nav-item" onclick="switchTab('history', this)"><span class="nav-icon">ğŸ“œ</span><span>GeÃ§miÅŸ</span></button>
            <button class="nav-item" onclick="switchTab('future', this)"><span class="nav-icon">â³</span><span>KapsÃ¼l</span></button>
            <button class="nav-item" onclick="switchTab('arena', this)"><span class="nav-icon">âš”ï¸</span><span>YarÄ±ÅŸma</span></button>
            <button class="nav-item" onclick="switchTab('store', this)"><span class="nav-icon">ğŸ›’</span><span>Pazar</span></button>
            <button class="nav-item" onclick="switchTab('desc', this)"><span class="nav-icon">â„¹ï¸</span><span>KÄ±lavuz</span></button>
        </div>

        <div id="viewHome" class="fade-in">
            <div class="card">
                <h4>HIZLI DERS GÄ°RÄ°ÅÄ°</h4>
                <div class="chips" id="chipsManual"></div>
                <input type="hidden" id="selectedSubject" value="">
                <div class="input-group">
                    <select id="entryDate" class="input-modern" style="flex:1;">
                        <option value="0">ğŸ“… BugÃ¼n</option>
                        <option value="1">âª DÃ¼n</option>
                        <option value="2">â®ï¸ 2 GÃ¼n Ã–nce</option>
                    </select>
                    <input type="number" id="entryDur" value="40" class="input-modern" style="flex:1;" placeholder="40" inputmode="numeric">
                </div>
                <button class="btn-action" id="btnSaveEntry" onclick="saveEntry()">KAYDET (+Puan) âœ…</button>
            </div>
            <div class="card" style="text-align:center;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="border:none; margin:0;">HAFTALIK HEDEF</h4>
                    <div onclick="changeStudentGoal()" style="cursor:pointer; background:#f1f5f9; padding:5px 10px; border-radius:10px; font-size:0.85rem; color:var(--text-sub); border:1px solid #e2e8f0;">
                        Hedef: <strong id="targetMins" style="color:var(--primary);">1000</strong>dk <i class="fa-solid fa-pen" style="font-size:0.7rem; margin-left:5px;"></i>
                    </div>
                </div>
                <div style="position:relative; height:200px; width:100%;"><canvas id="weeklyChart"></canvas></div>
                <div style="margin-top:15px; font-weight:800; font-size:1.1rem; color:var(--primary);" id="progText">%<span id="progVal">0</span> TamamlandÄ±</div>
                <button id="btnClaimWeekly" class="hidden btn-action" onclick="claimWeeklyBonus()" style="background:linear-gradient(135deg, #f59e0b, #d97706); margin-top:10px;">ğŸ† 500 Ã‡alÄ±ÅŸma YÄ±ldÄ±z PuanÄ± Ã–dÃ¼lÃ¼ Al</button>
            </div>
        </div>

        <div id="viewPomo" class="hidden fade-in">
            <div class="card" style="text-align:center;">
                <h4>ODAKLANMA MODU</h4>
                <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px;">Dersi seÃ§ ve sÃ¼reyi baÅŸlat.</p>
                <div class="chips" id="chipsPomo"></div>
                <input type="hidden" id="pomoSubject" value="">
                <div class="timer-display" id="timerDisplay">30:00</div>
                <div class="pomo-controls">
                    <button class="btn-pomo" style="background:#10b981;" onclick="startPomoTimer()" id="btnStartPomo">BAÅLAT â–¶</button>
                    <button class="btn-pomo" style="background:#ef4444;" onclick="requestStopPomo()">DURDUR â¹</button>
                </div>
                
                <div style="margin-top:20px; border-top:1px solid #f1f5f9; padding-top:15px;">
                    <label style="font-size:0.9rem; color:var(--text-sub); font-weight:bold; display:block; margin-bottom:10px;">SÃ¼re Ayarla (dk)</label>
                    <div style="display:flex; justify-content:center; align-items:center; gap:15px;">
                        <div class="btn-timer-adj" onclick="adjustTimer(-5)">-</div>
                        <input type="number" id="timerSet" value="30" oninput="updateTimerSet()" class="input-modern" style="width:80px; margin:0; padding:15px; text-align:center; font-size:1.5rem; font-weight:800; color:var(--primary);" inputmode="numeric">
                        <div class="btn-timer-adj" onclick="adjustTimer(5)">+</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewClan" class="hidden fade-in">
            <div id="myClanSection" class="hidden">
                <div class="card clan-card-modern">
                    <div class="clan-banner-modern" id="myClanIcon">ğŸº</div>
                    <div style="font-size:1.1rem; font-weight:700; color:var(--text-sub); margin-bottom:5px;">
                        ğŸ‘¥ <span id="myClanMembers">...</span> Alp | ğŸ† <span id="myClanScore">0</span> Puan
                    </div>
                    <div style="font-size:0.9rem; color:var(--primary); font-weight:800; margin-bottom:10px;">
                        <span id="myClanRankDisplay">SÄ±ralama HesaplanÄ±yor...</span>
                    </div>
                    <h2 id="myClanName" style="color:var(--primary-dark); font-size:1.8rem; margin-bottom:20px;">Bozkurtlar</h2>
                    
                    <div style="text-align:left; background:#f8fafc; padding:10px; border-radius:10px; margin-bottom:15px; max-height:150px; overflow-y:auto; border:1px solid #e2e8f0;">
                        <strong style="font-size:0.8rem; color:#64748b; margin-bottom:5px; display:block; border-bottom:1px solid #eee; padding-bottom:5px;">OTAÄ ALPLERÄ°:</strong>
                        <div id="myClanMemberList" style="font-size:0.9rem; color:#334155;">YÃ¼kleniyor...</div>
                    </div>

                    <div class="tore-box-modern">
                        <strong style="display:block; margin-bottom:10px;">ğŸ“œ ANA SANCAK TÃ–RESÄ°:</strong>
                        1. Yalan sÃ¶yleme, emanete ihanet etme.<br>2. BÃ¼yÃ¼ÄŸe saygÄ±, kÃ¼Ã§Ã¼ÄŸe sevgi.<br>3. Bilgi gÃ¼Ã§tÃ¼r, Ã§alÄ±ÅŸmak ibadettir.<br>4. OtaÄŸ'Ä±n ÅŸerefi, senin ÅŸerefindir.
                    </div>
                    <button onclick="leaveClan()" style="background:#fee2e2; color:var(--danger); padding:12px 25px; font-size:0.9rem; border-radius:15px; font-weight:700;">OtaÄŸdan AyrÄ±l</button>
                </div>
            </div>
            <div id="noClanSection" class="card" style="text-align:center;">
                <h4>HENÃœZ BÄ°R OTAÄIN YOK</h4>
                <div style="font-size:0.9rem; color:var(--warning); margin-bottom:15px; font-weight:bold; background:#fffbeb; padding:10px; border-radius:12px; border:1px solid #fcd34d;">
                    âš ï¸ Kural: Her OtaÄŸ en fazla 5 Alp barÄ±ndÄ±rabilir. Kontenjan dolarsa baÅŸka OtaÄŸ seÃ§.
                </div>
                <button id="btnCreateClan" class="btn-action" onclick="window.openCreateClanModal()">OtaÄŸ Kurma Ä°steÄŸi GÃ¶nder</button>
                <hr style="margin:20px 0; border-top:1px solid #f1f5f9;">
                <h5 style="text-align:left; display:flex; justify-content:space-between; align-items:center;">
                    KatÄ±labileceÄŸin OtaÄŸlar 
                    <button onclick="loadJoinableClans()" style="font-size:0.7rem; padding:3px 8px; background:#e0f2f1; color:var(--primary); border-radius:8px;">Yenile</button>
                </h5>
                <div id="clanJoinList" style="max-height:200px; overflow-y:auto; text-align:left;">YÃ¼kleniyor...</div>
            </div>
             <div class="card"><h4>ğŸ† OTAÄLAR SIRALAMASI</h4><div id="clanLeaderboard">Veriler Ã§ekiliyor...</div></div>
        </div>

        <div id="viewArena" class="hidden fade-in">
            <div class="card">
                <h4>âš”ï¸ Ã‡ALIÅMA ARENASI</h4>
                <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px;">Åu an seninle birlikte Ã§alÄ±ÅŸanlar.</p>
                <div id="arenaList" style="max-height:300px; overflow-y:auto; margin-bottom:20px;">
                    <div style="text-align:center; padding:20px; color:#999;">Arenaya baÄŸlanÄ±lÄ±yor...</div>
                </div>
                <div style="border-top:1px solid #e2e8f0; padding-top:15px; text-align:center;">
                     <div class="timer-display" id="arenaTimerDisplay" style="color:var(--warning);">00:00</div>
                     <button class="btn-action" id="arenaStartBtn" onclick="startArenaSession()">SAVAÅI BAÅLAT âš”ï¸</button>
                     <div id="arenaControls" class="hidden" style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                         <button style="background:linear-gradient(135deg, #f59e0b, #d97706); color:white; padding:10px 20px; border-radius:12px; font-weight:700;" onclick="boostArenaTime()">âš¡ ZAMAN ARTIR</button>
                         <button style="background:#ef4444; color:white; padding:10px 20px; border-radius:12px; font-weight:700;" onclick="requestStopArena()">PES ET ğŸ³ï¸</button>
                     </div>
                </div>
            </div>
        </div>

        <div id="viewStore" class="hidden fade-in">
            <div class="card" style="background:#f0fdf4; border-color:#bbf7d0;">
                <h4 style="color:#166534;">ğŸ¯ NASIL Ã‡ALIÅMA YILDIZ PUANI KAZANILIR?</h4>
                <div style="font-size:0.9rem; color:#166534; line-height: 1.6;">
                    <div>âš¡ <strong>Normal Ã‡alÄ±ÅŸma (GiriÅŸ):</strong> 1 Dakika = 1 Puan (OtaÄŸ: 1.5)</div>
                    <div>ğŸ… <strong>Odaklanma (SayaÃ§):</strong> 1 Dakika = 1.5 Puan (OtaÄŸ: 2.0)</div>
                    <div>âš”ï¸ <strong>Arena YarÄ±ÅŸmasÄ±:</strong> 1 Dakika = 2.0 Puan (OtaÄŸ: 2.5)</div>
                    <div>â›º <strong>OtaÄŸ Bonusu:</strong> Her dakikaya ekstra +0.5 Puan</div>
                    <div>ğŸ“… <strong>HaftalÄ±k Hedef:</strong> +500 Puan</div>
                    <div>ğŸ“… <strong>Seri Bonusu (7 GÃ¼n):</strong> +400 Puan</div>
                    <div>âœ‰ï¸ <strong>Zaman KapsÃ¼lÃ¼:</strong> Mektup Kilitleme = +200 Puan</div>
                </div>
            </div>
            <div class="card">
                <h4>KÄ°MLÄ°ÄÄ°NÄ° SEÃ‡ (Ã‡IKARTMALAR)</h4>
                <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px;">PuanlarÄ±nÄ± harcayarak yeni bir simge seÃ§.</p>
                <div class="store-grid" id="avatarShop"></div>
            </div>
        </div>

        <div id="viewFuture" class="hidden fade-in">
            <div class="card">
                <h4>ZAMAN KAPSÃœLÃœ ğŸ•°ï¸</h4>
                <div style="background:#fffbeb; padding:10px; border-radius:12px; margin-bottom:15px; border:1px solid #fcd34d; color:#92400e; font-size:0.85rem;">
                    âš ï¸ KapsÃ¼l: <strong id="capsuleUnlockDisplay">YÃ¼kleniyor...</strong> tarihine kadar kilitli kalacak.
                </div>
                <div id="capsuleLocked" class="hidden" style="text-align:center; padding:20px; background:#f1f5f9; border-radius:20px;">
                    <div style="font-size:3rem;">ğŸ”’</div>
                    <h3>KÄ°LÄ°TLÄ°</h3>
                    <p>MÃ¼hÃ¼r henÃ¼z aÃ§Ä±lmadÄ±.</p>
                </div>
                <div id="capsuleOpen" class="hidden" style="text-align:center; padding:20px; background:#dcfce7; border-radius:20px;">
                    <div style="font-size:3rem;">ğŸ”“</div>
                    <h3>MÃœHÃœR AÃ‡ILDI</h3>
                    <p id="capsuleContentText" style="font-style:italic; font-weight:600;"></p>
                </div>
                <div id="capsuleInputArea">
                    <div style="background:#fff7ed; color:#c2410c; padding:10px; border-radius:10px; font-size:0.85rem; margin-bottom:10px; border:1px solid #ffedd5;">
                        âš ï¸ <strong>Dikkat:</strong> MesajÄ±nÄ±zÄ± tam ve eksiksiz yazÄ±nÄ±z. MÃ¼hÃ¼rlendikten sonra geri dÃ¶nÃ¼ÅŸÃ¼ yoktur.
                    </div>
                    <textarea id="futureMsg" class="input-modern" placeholder="Gelecekteki kendine ne sÃ¶ylemek istersin?" style="height:150px; text-align:left; margin-bottom:10px;"></textarea>
                    <button class="btn-action" id="btnSaveFuture" onclick="saveFuture()">MÃœHÃœRLE VE GÃ–NDER (+200p) ğŸ”’</button>
                </div>
            </div>
        </div>

        <div id="viewDesc" class="hidden fade-in">
            <div class="card">
                <h4 style="color:#004d40; border-bottom:2px solid #e2e8f0; padding-bottom:15px; margin-bottom:20px;">BÄ°LGE TAKÄ°P SÄ°STEMÄ° KILAVUZU</h4>
                
                <div class="desc-box">
                    <span class="desc-title" style="display:flex; align-items:center; gap:8px; font-size:1rem;">âš”ï¸ RÃ¼tbe Sistemi</span>
                    <p style="font-size:0.8rem; color:#666;">(RÃ¼tbeler <strong>Toplam Ã‡alÄ±ÅŸma DakikasÄ±na</strong> gÃ¶re belirlenir. Puanlar rÃ¼tbeyi etkilemez.)</p>
                    <table class="points-table" style="margin-top:15px;">
                        <tr><td style="font-weight:700;">ğŸªµ Ã‡Ä±rak</td><td style="text-align:right;">0 - 499 dk</td></tr>
                        <tr><td style="font-weight:700;">ğŸ”¨ Kalfa</td><td style="text-align:right;">500 - 1499 dk</td></tr>
                        <tr><td style="font-weight:700;">âš”ï¸ SavaÅŸÃ§Ä±</td><td style="text-align:right;">1500 - 2999 dk</td></tr>
                        <tr><td style="font-weight:700;">ğŸ›¡ï¸ Komutan</td><td style="text-align:right;">3000 - 4999 dk</td></tr>
                        <tr><td style="font-weight:700;">ğŸ“œ Bilge</td><td style="text-align:right;">5000 - 9999 dk</td></tr>
                        <tr><td style="font-weight:700;">ğŸ‘‘ Hakan</td><td style="text-align:right; font-weight:800; color:#d97706;">10000+ dk</td></tr>
                    </table>
                </div>
                <div class="desc-box" style="border-bottom:none;">
                    <span class="desc-title" style="display:flex; align-items:center; gap:8px; font-size:1rem;">â›º OtaÄŸ (Klan) MantÄ±ÄŸÄ±</span>
                    <p class="desc-text">ArkadaÅŸlarÄ±nla bir OtaÄŸ kur veya katÄ±l. KazandÄ±ÄŸÄ±n her puan OtaÄŸÄ±na eklenir. En Ã§ok Ã§alÄ±ÅŸan OtaÄŸ zirveye oturur.</p>
                    <div style="margin-top:10px; background:#fffbeb; padding:10px; border-radius:10px; border:1px solid #fcd34d; font-size:0.85rem; color:#92400e;">
                        <strong>âš–ï¸ ADALET KURALI (1/5):</strong><br>
                        GÃ¼Ã§ dengesini korumak iÃ§in, bir OtaÄŸ en fazla 5 Alp barÄ±ndÄ±rabilir. Kontenjan dolarsa baÅŸka bir OtaÄŸ seÃ§melisin.
                    </div>
                </div>
            </div>
        </div>

        <div id="viewHistory" class="hidden fade-in">
            <div class="card" style="padding: 25px;">
                <h4 style="color:#475569; font-weight:800; margin:0 0 20px 0; border-bottom:1px solid #f1f5f9; padding-bottom:15px; letter-spacing:1px; font-size:0.9rem;">SON Ã‡ALIÅMALAR</h4>
                <div id="historyListContainer"><div style="text-align:center; color:#aaa; padding:20px;">YÃ¼kleniyor...</div></div>
            </div>
        </div>

        <div class="app-footer">Â© 2025 Remzi<br><a href="mailto:yabguhakan2025@gmail.com" style="color:var(--primary); text-decoration:none; font-weight:bold;">yabguhakan2025@gmail.com</a></div>
        
        <div class="wise-coach-container" id="wiseCoachContainer" style="display:none;">
            <div class="coach-bubble" id="coachBubble" onclick="showNextMessage()">
                <span id="owlMsgText">MesajÄ±n var!</span>
                </div>
            <div class="wise-avatar" id="wiseAvatar" onclick="openMsgModal()">ğŸ¦‰<div class="coach-badge hidden" id="coachBadge">0</div></div>
        </div>
        
        <div id="modalMsg" class="modal hidden" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="modal-content">
                <h3 style="margin-top:0;">Posta Kutusu ğŸ“¬</h3>
                <div id="msgList"></div>
                <button onclick="document.getElementById('modalMsg').classList.add('hidden')" style="margin-top:10px; width:100%; padding:10px; background:#ddd; border-radius:10px;">Kapat</button>
            </div>
        </div>
    </div>

    <div id="modalCreateClan" class="modal hidden fade-in" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="modal-content">
            <h3>Yeni OtaÄŸ Kur â›º</h3>
            <input type="text" id="newClanName" class="input-modern" placeholder="OtaÄŸ AdÄ±" style="margin-bottom:10px;">
            <label style="font-size:0.8rem; color:#666;">OtaÄŸ SancaÄŸÄ± SeÃ§:</label>
            <div id="clanIconSelect" class="chips" style="margin-bottom:10px; justify-content: flex-start; overflow-x: auto; padding-bottom: 10px;"></div>
            <input type="hidden" id="selectedClanIcon" value="ğŸº">
            <button class="btn-action" onclick="window.createClanRequest()">HAKANA ARZ ET</button>
            <button onclick="document.getElementById('modalCreateClan').classList.add('hidden')" style="margin-top:10px; width:100%; padding:10px; background:#fee2e2; color:red; border-radius:10px;">Ä°ptal</button>
        </div>
    </div>
    
    <div id="modalProfile" class="modal hidden fade-in"><div class="modal-content"><h3>Profil</h3><input type="text" id="editProfileName" class="input-modern"><button class="btn-action" onclick="saveUserProfile()" style="margin-top:10px;">Kaydet</button><button onclick="handleLogout()" style="margin-top:10px; width:100%; padding:10px; background:#fee2e2; color:red; border-radius:10px;">Ã‡IKIÅ YAP</button><button onclick="document.getElementById('modalProfile').classList.add('hidden')" style="margin-top:10px; width:100%; padding:10px;">Kapat</button></div></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, addDoc, deleteDoc, getDocs, query, where, onSnapshot, serverTimestamp, increment, deleteField, runTransaction, orderBy, limit, writeBatch, collectionGroup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    window.onerror = function(msg, url, line) { console.error("Hata: " + msg); }; 
    const firebaseConfig = { apiKey: "AIzaSyBkJg6hiMPcgM-bywHjUCKdD8CapA1VDHk", authDomain: "ogrencitakip-bcdbd.firebaseapp.com", projectId: "ogrencitakip-bcdbd", storageBucket: "ogrencitakip-bcdbd.firebasestorage.app", messagingSenderId: "74510222174", appId: "1:74510222174:web:9d379386762064ee0f45cf" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
    const ADMIN_EMAIL = "mremzi@gmail.com";
    const SUBJECTS = ['Matematik','TÃ¼rkÃ§e','Fen','Sosyal','Ä°ngilizce','Din','Kitap','DiÄŸer'];
    const AVATAR_SHOP = [ { icon: 'ğŸº', name: 'Bozkurt', cost: 500 }, { icon: 'ğŸ¹', name: 'KemankeÅŸ', cost: 600 }, { icon: 'âš”ï¸', name: 'Alp', cost: 700 }, { icon: 'ğŸ¦…', name: 'GÃ¶kdoÄŸan', cost: 800 }, { icon: 'ğŸ', name: 'SÃ¼vari', cost: 900 }, { icon: 'ğŸ›¡ï¸', name: 'MuhafÄ±z', cost: 1000 }, { icon: 'âš“', name: 'Levent', cost: 1200 }, { icon: 'ğŸ—¡ï¸', name: 'AkÄ±ncÄ±', cost: 1300 }, { icon: 'ğŸ“œ', name: 'Bilge', cost: 1500 }, { icon: 'ğŸ”­', name: 'GÃ¶kbilimci', cost: 1800 }, { icon: 'ğŸ‰', name: 'Ejderha', cost: 2000 }, { icon: '<i class="fa-solid fa-dragon" style="color:#d97706;"></i>', name: 'Anka KuÅŸu', cost: 2000 }, { icon: 'ğŸ¥‹', name: 'Pehlivan', cost: 2200 }, { icon: 'ğŸ‘‘', name: 'Hakan', cost: 5000 } ];
    const CLAN_ICONS = [ {i:'ğŸº',n:'Bozkurt'}, {i:'ğŸ¦…',n:'Kartal'}, {i:'ğŸ¹',n:'Ok&Yay'}, {i:'âš”ï¸',n:'KÄ±lÄ±Ã§lar'}, {i:'ğŸ',n:'At'}, {i:'â›º',n:'OtaÄŸ'}, {i:'ğŸ›¡ï¸',n:'Kalkan'}, {i:'â˜€ï¸',n:'GÃ¼neÅŸ'}, {i:'ğŸŒ™',n:'Hilal'}, {i:'ğŸ”¥',n:'AteÅŸ'}, {i:'ğŸ”ï¸',n:'DaÄŸ'}, {i:'ğŸŒŠ',n:'Deniz'} ];
    const RANKS = [ { name: "Ã‡Ä±rak ğŸªµ", threshold: 0 }, { name: "Kalfa ğŸ”¨", threshold: 500 }, { name: "SavaÅŸÃ§Ä± âš”ï¸", threshold: 1500 }, { name: "Komutan ğŸ›¡ï¸", threshold: 3000 }, { name: "Bilge ğŸ“œ", threshold: 5000 }, { name: "Hakan ğŸ‘‘", threshold: 10000 } ];
    const OWL_MESSAGES = [ "HoÅŸ geldin Bilgi AvcÄ±sÄ±! ğŸ¹", "GÃ¶zlerim yollarda kaldÄ±! ğŸ‘€", "Ã‡alÄ±ÅŸkanlarÄ±n kralÄ± burada! ğŸ‘‘", "BugÃ¼n rekor kÄ±racak mÄ±yÄ±z? ğŸš€", "UÃ§uÅŸa hazÄ±r mÄ±sÄ±n? ğŸ¦‰", "Seni gÃ¶rmek ne gÃ¼zel! ğŸŒŸ", "KitaplarÄ±n seni Ã¶zledi! ğŸ“š", "SÄ±cak bir kahve ve ders? â˜•", "ZamanÄ± bÃ¼kmeye hazÄ±r ol! â³", "Sahne senin, gÃ¶ster kendini! ğŸ¤" ];

    let currentUser=null, isLogin=true, myChart=null, unsubStudentData = null;
    let pomoInterval = null, isPomoRunning = false, pomoEndTime = 0, pomoTotalDuration = 0;
    let arenaInterval = null, isArenaRunning = false, arenaEndTime = 0, arenaTotalDuration = 0;
    let isArenaWaiting = false; 
    let wakeLock = null;
    let previousRank = null; 
    let owlQueue = []; 
    let activeGladiators = 0;
    let unsubClanLeaderboard = null;

    function formatDateTR(timestamp) {
        if (!timestamp) return '';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
    }

    onAuthStateChanged(auth, async(user)=>{
        if(user){
            if(user.email === ADMIN_EMAIL){ 
                await signOut(auth);
                Swal.fire("Yasak BÃ¶lge", "HakanÄ±m, burasÄ± Alplerin meydanÄ±dÄ±r. LÃ¼tfen YÃ¶netici KapÄ±sÄ±ndan giriniz.", "error");
                return; 
            }
            currentUser=user; 
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            document.getElementById('wiseCoachContainer').style.display = 'flex';
            document.getElementById('stName').innerText = user.displayName ? user.displayName.split(' ')[0] : 'Ã–ÄŸrenci';
            
            // --- OTO DÃœZELTME & BAÅLATMA ---
            await forceRepairUserData(user.uid);
            await initStudent(user.uid);
        } else {
            currentUser=null;
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
        }
    });

    // --- YENÄ°: VERÄ° TÄ°PÄ° TAMÄ°RCÄ°SÄ° (HATA KORUMASI) ---
    async function forceRepairUserData(uid) {
        try {
            const userRef = doc(db, "users", uid);
            const snap = await getDoc(userRef);
            if(snap.exists()) {
                const data = snap.data();
                const updates = {};
                // EÄŸer XP veya Gold "String" olarak kalmÄ±ÅŸsa, sayÄ±ya Ã§evir
                if(typeof data.xp === 'string') updates.xp = parseInt(data.xp, 10) || 0;
                if(typeof data.gold === 'string') updates.gold = parseInt(data.gold, 10) || 0;
                if(typeof data.totalMinutes === 'string') updates.totalMinutes = parseInt(data.totalMinutes, 10) || 0;
                
                if(Object.keys(updates).length > 0) {
                    await updateDoc(userRef, updates);
                    console.log("Veri tipleri dÃ¼zeltildi:", updates);
                }
            }
        } catch(e) { console.error("Tamir hatasÄ±:", e); }
    }

    window.switchAuthMode = (login) => { isLogin = login; document.getElementById('authBtn').innerText = isLogin ? "GÄ°RÄ°Å YAP" : "KAYIT OL"; document.getElementById('regName').classList.toggle('hidden', isLogin); document.getElementById('tabLogin').classList.toggle('active', isLogin); document.getElementById('tabRegister').classList.toggle('active', !isLogin); document.getElementById('authDesc').innerText = isLogin ? "Maceraya devam etmek iÃ§in giriÅŸ yap." : "Yeni bir efsane doÄŸuyor. OtaÄŸÄ±mÄ±za katÄ±l."; };
    window.handleLogin = async () => { const btn = document.getElementById('authBtn'); btn.innerText = "Ä°ÅŸleniyor..."; btn.disabled = true; const e = document.getElementById('email').value; const p = document.getElementById('password').value; try{ if(isLogin) await signInWithEmailAndPassword(auth,e,p); else { const n = document.getElementById('regName').value; if(!n) throw new Error("Ä°sim gerekli"); const c = await createUserWithEmailAndPassword(auth,e,p); await updateProfile(c.user,{displayName: n}); } } catch(err){ document.getElementById('authError').style.display='block'; document.getElementById('authError').innerText = "Hata: " + err.message; } finally { btn.innerText = isLogin ? "GÄ°RÄ°Å YAP" : "KAYIT OL"; btn.disabled = false; } };
    window.handleLogout = () => { if(unsubStudentData) unsubStudentData(); signOut(auth); };

    async function initStudent(uid){
        const userRef = doc(db,"users",uid); const userSnap = await getDoc(userRef);
        if(!userSnap.exists()){ await setDoc(userRef, { email: currentUser.email, displayName: currentUser.displayName, totalMinutes: 0, xp: 0, gold: 0, weeklyGoal: 1000, avatar: 'ğŸ“', createdAt: serverTimestamp(), streak: 0 }); }
        
        onSnapshot(doc(db, "users", uid), async (docSnap) => {
            const data = docSnap.data(); if(!data) return;
            
            const userXP = parseInt(data.xp) || 0; // Her zaman sayÄ±ya Ã§evir
            const userGold = parseInt(data.gold) || 0;
            const userMinutes = parseInt(data.totalMinutes) || 0; 
            
            document.getElementById('stXP').innerText = userXP;
            document.getElementById('stGold').innerText = userGold;
            document.getElementById('targetMins').innerText = data.weeklyGoal || 1000;
            if(data.avatar) document.getElementById('userAvatar').innerHTML = data.avatar;
            window.lastBonusDate = data.lastBonusDate;
            
            const newRankObj = updatePlayerRank(userMinutes);
            if(previousRank && previousRank !== newRankObj.name) {
                if (userMinutes > 0) {
                    Swal.fire({ title: 'RÃœTBEN YÃœKSELDÄ° YÄ°ÄÄ°DÄ°M! ğŸ‰', html: `GÃ¶sterdiÄŸin azim ve gayret ile <span style="color:#4f46e5; font-weight:bold;">${newRankObj.name}</span> mertebesine eriÅŸtin.`, icon: 'success', backdrop: `rgba(0,0,123,0.4)` });
                    confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                    addToOwlQueue("Ä°nanÄ±lmazsÄ±n! Yeni rÃ¼tben kutlu olsun! ğŸ‰");
                }
            }
            previousRank = newRankObj.name;
            checkBonusButtonVisibility(uid); 
            if (!data.clanId) checkClanStatus(uid);
            else checkClanStatus(uid);
        });
        renderChips(); renderAvatarShop(); renderClanIcons(); listenStudentData(uid); checkTimeCapsule(uid); listenStudentMessages(uid); showWiseOwlWelcome();
    }
    
    function addToOwlQueue(msg) {
        if(owlQueue.length > 0 && owlQueue[owlQueue.length-1] === msg) return;
        owlQueue.push(msg);
        const bubble = document.getElementById('coachBubble');
        if (!bubble.classList.contains('show')) showNextMessage();
    }

    window.showNextMessage = () => {
        const bubble = document.getElementById('coachBubble');
        const avatar = document.getElementById('wiseAvatar');
        const msgSpan = document.getElementById('owlMsgText');
        
        if (owlQueue.length > 0) {
            const msg = owlQueue.shift();
            msgSpan.innerText = msg;
            bubble.classList.add('show');
            avatar.classList.add('owl-excited');
        } else {
            bubble.classList.remove('show');
            avatar.classList.remove('owl-excited');
        }
    };

    async function showWiseOwlWelcome() { 
        let msg = ""; 
        try { 
            const snap = await getDocs(collection(db, "owl_messages")); 
            if (!snap.empty) msg = snap.docs[Math.floor(Math.random() * snap.docs.length)].data().text;
            else msg = OWL_MESSAGES[Math.floor(Math.random() * OWL_MESSAGES.length)]; 
        } catch (e) { msg = OWL_MESSAGES[Math.floor(Math.random() * OWL_MESSAGES.length)]; } 
        addToOwlQueue(msg);
        const d = new Date(); const day = d.getDay(); 
        const userRef = await getDoc(doc(db,"users",currentUser.uid));
        const userData = userRef.data();
        if(userData.streak > 0 && userData.streak < 7) { addToOwlQueue(`Devam et ${userData.streak}. gÃ¼ndesin! 7 gÃ¼n seri bonusunu kazanacaÄŸÄ±z! ğŸ”¥`); }
    }
    
    function updatePlayerRank(minutes) { 
        let currentRank = RANKS[0]; let nextRank = RANKS[RANKS.length - 1]; 
        for (let i = 0; i < RANKS.length; i++) { if (minutes >= RANKS[i].threshold) { currentRank = RANKS[i]; if (i < RANKS.length - 1) nextRank = RANKS[i + 1]; else nextRank = null; } } 
        document.getElementById('rankBadgeDisplay').innerText = `${currentRank.name} (${minutes} dk)`; 
        if (nextRank) { const pct = Math.min(100, Math.max(0, ((minutes - currentRank.threshold) / (nextRank.threshold - currentRank.threshold)) * 100)); document.getElementById('xpProgressBar').style.width = `${pct}%`; } else { document.getElementById('xpProgressBar').style.width = '100%'; }
        return currentRank;
    }

    function renderChips(){ const c=document.getElementById('chipsManual');const cp=document.getElementById('chipsPomo'); c.innerHTML="";cp.innerHTML=""; SUBJECTS.forEach(s=>{ const h=`<div class="chip-modern" onclick="selSub('${s}',this)">${s}</div>`; c.innerHTML+=h; cp.innerHTML+=h; }); }
    window.selSub=(s,el)=>{ document.querySelectorAll('.chip-modern').forEach(x=>x.classList.remove('active')); el.classList.add('active'); if(!document.getElementById('viewPomo').classList.contains('hidden')) document.getElementById('pomoSubject').value=s; else document.getElementById('selectedSubject').value=s; };
    
    function renderAvatarShop() { 
        const g=document.getElementById('avatarShop'); 
        g.innerHTML = ""; 
        AVATAR_SHOP.forEach((i, idx) => { 
            g.innerHTML += `<div class="store-card"><div class="store-icon">${i.icon}</div><span class="store-name">${i.name}</span><span class="store-price">${i.cost} AltÄ±n</span><button class="btn-store" onclick="buyAvatar(${idx}, ${i.cost}, this)">SatÄ±n Al</button></div>`; 
        }); 
    }
    
    window.buyAvatar = async (idx, cost, btn) => { 
        if(!currentUser) return Swal.fire("Hata", "Oturum aÃ§Ä±k deÄŸil.", "error");
        
        btn.disabled = true; 
        try { 
            const currentGold = parseInt(document.getElementById('stGold').innerText, 10) || 0; 
            const costInt = parseInt(cost, 10); 

            if(currentGold < costInt) { 
                Swal.fire("Yetersiz AltÄ±n", `Bu simge ${costInt} altÄ±n deÄŸerinde.`, "error"); 
                btn.disabled = false;
                return; 
            } 
            
            const item = AVATAR_SHOP[idx];
            if(confirm(`"${item.name}" simgesini ${costInt} AltÄ±n karÅŸÄ±lÄ±ÄŸÄ±nda satÄ±n alÄ±p hemen kullanmak istiyor musun?`)){ 
                await updateDoc(doc(db,"users",currentUser.uid), { 
                    gold: increment(-costInt), 
                    avatar: item.icon 
                }); 
                
                Swal.fire({ title: "HayÄ±rlÄ± Olsun!", text: "Yeni simgen rÃ¼tbenle beraber parlÄ±yor.", icon: "success", timer: 2000, showConfirmButton: false }); 
                confetti(); 
            } else {
                btn.disabled = false;
            }
        } catch(e) { 
            Swal.fire("Hata", "SatÄ±n alma hatasÄ±: " + e.message, "error"); 
            btn.disabled = false;
        } 
    };

    function renderClanIcons() { const c=document.getElementById('clanIconSelect'); c.innerHTML = ""; CLAN_ICONS.forEach(i => { c.innerHTML += `<div class="chip-modern" onclick="selectClanIcon(this)" style="display:flex; flex-direction:column; align-items:center; padding:10px;"><span>${i.i}</span><span style="font-size:0.7rem;">${i.n}</span></div>`; }); }

    window.claimWeeklyBonus = async () => { const btn = document.getElementById('btnClaimWeekly'); btn.disabled = true; try { await updateDoc(doc(db,"users",currentUser.uid), { xp: increment(500), gold: increment(500), lastBonusDate: serverTimestamp() }); await addDoc(collection(db,"users",currentUser.uid,"sessions"), { subject: "HaftalÄ±k Hedef ğŸ†", duration: 0, points: 500, createdAt: serverTimestamp(), type: 'bonus', dateStr: new Date().toLocaleDateString('tr-TR') }); window.lastBonusDate = { toDate: () => new Date() }; checkBonusButtonVisibility(currentUser.uid); Swal.fire("Tebrikler!", "+500 Ã‡alÄ±ÅŸma YÄ±ldÄ±z PuanÄ±", "success"); confetti(); } catch(e) { console.error(e); btn.disabled = false; } };
    function checkBonusButtonVisibility(uid) { if(!window.currentWeeklyTotal) return; if(!uid && currentUser) uid=currentUser.uid; if(!uid) return; const goal = parseInt(document.getElementById('targetMins').innerText)||1000; const btn = document.getElementById('btnClaimWeekly'); const wa = new Date(); const day = wa.getDay(); const diff = wa.getDate() - day + (day === 0 ? -6 : 1); wa.setDate(diff); wa.setHours(0, 0, 0, 0); const q = query(collection(db, "users", uid, "sessions"), where("type", "==", "bonus"), where("subject", "==", "HaftalÄ±k Hedef ğŸ†"), where("createdAt", ">=", wa)); getDocs(q).then(snap => { const alreadyClaimed = !snap.empty; if (window.currentWeeklyTotal >= goal && !alreadyClaimed) { btn.classList.remove('hidden'); } else { btn.classList.add('hidden'); } }); }

    function listenStudentData(uid){
        if(unsubStudentData) unsubStudentData();
        const q = query(collection(db,"users",uid,"sessions"), orderBy("createdAt", "desc"), limit(50));
        unsubStudentData = onSnapshot(q, (snap)=>{
            let tw=0; const list=document.getElementById('historyListContainer'); list.innerHTML="";
            const wa = new Date(); const day = wa.getDay(); const diff = wa.getDate() - day + (day === 0 ? -6 : 1); wa.setDate(diff); wa.setHours(0, 0, 0, 0); 
            if(snap.empty) { list.innerHTML="<div style='text-align:center; padding:20px; color:#94a3b8; font-style:italic;'>HenÃ¼z kayÄ±tlÄ± Ã§alÄ±ÅŸma yok.</div>"; } else {
                snap.forEach(d=>{ 
                    const dt = d.data(); const cr = dt.createdAt ? dt.createdAt.toDate() : new Date(); const subName = dt.subject || "";
                    const dateDisplay = formatDateTR(dt.createdAt);
                    const isBonus = dt.type === 'bonus' || /Hafta|Hedef|Seri|KapsÃ¼l/i.test(subName);
                    if(cr >= wa && !isBonus) { tw += (parseInt(dt.duration) || 0); }
                    if(list.children.length < 20) {
                        let icon = 'ğŸ“š'; let rowStyle = 'background:white; border-bottom:1px solid #f1f5f9;'; let titleColor = '#0f172a'; let durationBadge = `<span style="color:#64748b;">${dt.duration} dk</span>`; let displayPoints = dt.points || 0; 
                        if(isBonus) { icon = 'ğŸ†'; rowStyle = 'background:#fffbeb; border:1px solid #fcd34d; border-radius:12px; margin-bottom:8px;'; titleColor = '#b45309'; durationBadge = '<span style="background:#f59e0b; color:white; padding:2px 8px; border-radius:6px; font-size:0.7rem; font-weight:bold;">Ã–DÃœL</span>'; if(/Hafta|Hedef/i.test(subName)) displayPoints = 500; else if(/Seri/i.test(subName) && displayPoints < 400) displayPoints = 400; else if(/KapsÃ¼l/i.test(subName)) displayPoints = 200; }
                        else if(dt.type === 'arena' || /Arena/i.test(subName)) { icon = 'âš”ï¸'; rowStyle = 'background:#fef2f2; border:1px solid #fca5a5; border-radius:12px; margin-bottom:8px;'; titleColor = '#991b1b'; }
                        else if(dt.type === 'pomodoro' || dt.type === 'pomo') { icon = 'â±ï¸'; rowStyle = 'background:#f0fdf4; border:1px solid #86efac; border-radius:12px; margin-bottom:8px;'; titleColor = '#166534'; }
                        list.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px 10px; ${rowStyle}"><div style="display:flex; align-items:center; gap:12px;"><div style="font-size:1.4rem;">${icon}</div><div style="display:flex; flex-direction:column;"><span style="font-weight:800; font-size:0.95rem; color:${titleColor};">${subName}</span><span style="font-size:0.75rem; color:#64748b;">${dateDisplay} â€¢ ${durationBadge}</span></div></div><span style="font-weight:800; color:#6366f1; font-size:1.1rem;">+${displayPoints} âœ¨</span></div>`;
                    }
                }); 
            }
            window.currentWeeklyTotal = tw; const goal = parseInt(document.getElementById('targetMins').innerText) || 1000; document.getElementById('progVal').innerText = Math.min(100, Math.round((tw/goal)*100)); updateStudentChart(tw, goal); checkBonusButtonVisibility(uid); 
        });
    }

    function updateStudentChart(val, goal){ const ctx = document.getElementById('weeklyChart').getContext('2d'); if(myChart) myChart.destroy(); myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['YapÄ±lan', 'Kalan'], datasets: [{ data: [val, Math.max(0, goal-val)], backgroundColor: ['#009688', '#e2e8f0'], borderWidth: 0 }] }, options: { cutout: '80%', maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
    
    // --- GÃœNCELLENMÄ°Å KAYIT (HIZLI GÄ°RÄ°Å HATASI Ã‡Ã–ZÃœMÃœ) ---
    window.saveEntry = async () => { 
        const btn = document.getElementById('btnSaveEntry'); 
        if(btn.disabled) return; 

        // 1. DERS SEÃ‡Ä°MÄ° KONTROLÃœ (Eksikse hata ver)
        const sub = document.getElementById('selectedSubject').value; 
        if(!sub) return Swal.fire("Eksik Bilgi", "LÃ¼tfen yukarÄ±daki kutucuklardan bir ders seÃ§.", "warning");

        const durInput = document.getElementById('entryDur').value;
        const dur = parseInt(durInput, 10); 
        
        if(!dur || isNaN(dur)) return Swal.fire("Hata", "LÃ¼tfen geÃ§erli bir sÃ¼re gir.", "warning");
        if(dur < 10) return Swal.fire("Ã‡ok KÄ±sa", "En az 10 dakika girmelisin.", "warning");

        btn.disabled = true; btn.innerText = "Kaydediliyor..."; 

        try { 
            const offset = parseInt(document.getElementById('entryDate').value) || 0; 
            const recordDate = new Date(); 
            recordDate.setDate(recordDate.getDate() - offset); 
            recordDate.setHours(12,0,0,0); 
            
            let multiplier = 1.0; 
            let bonusText = ""; 
            if (window.userClanId) { multiplier += 0.5; bonusText = " (OtaÄŸ Bonusu Aktif ğŸ”¥)"; } 
            
            const points = Math.ceil(dur * multiplier); 

            // Batch kullanarak iÅŸlemleri birleÅŸtir (Veri tutarlÄ±lÄ±ÄŸÄ± iÃ§in)
            const batch = writeBatch(db);
            
            const sessionRef = doc(collection(db, "users", currentUser.uid, "sessions"));
            batch.set(sessionRef, { 
                subject: sub, 
                duration: dur, 
                points: points, 
                createdAt: recordDate, 
                dateStr: recordDate.toLocaleDateString('tr-TR'), 
                type: 'manual' 
            });

            const userRef = doc(db, "users", currentUser.uid);
            batch.update(userRef, { 
                totalMinutes: increment(dur), 
                xp: increment(points), 
                gold: increment(points), 
                lastStudyDate: serverTimestamp() 
            });
            
            await batch.commit();

            // OtaÄŸ puanÄ± gÃ¼ncellemesini ayrÄ±ca yap (Hata olursa ana iÅŸlem bozulmasÄ±n)
            if (window.userClanId) {
                try {
                    await updateDoc(doc(db, "clans", window.userClanId), { totalScore: increment(points) });
                } catch(e) { console.log("OtaÄŸ puanÄ± gÃ¼ncellenemedi:", e); }
            }
            
            await checkStreakAndAward(currentUser.uid); 
            
            Swal.fire("Kaydedildi!", `+${points} Puan ${bonusText}`, "success"); 
            confetti(); 

            // Formu sÄ±fÄ±rla
            document.getElementById('entryDur').value = "40";
            document.getElementById('selectedSubject').value = "";
            document.querySelectorAll('.chip-modern').forEach(x=>x.classList.remove('active'));

        } catch(e) { 
            console.error(e);
            Swal.fire("Hata", "KayÄ±t baÅŸarÄ±sÄ±z: " + e.message, "error"); 
        } finally { 
            setTimeout(() => { btn.disabled = false; btn.innerText = "KAYDET (+Puan) âœ…"; }, 1000); 
        } 
    };
    
    // --- GÃœNCELLENMÄ°Å SAYAÃ‡ AYARLARI ---
    window.updateTimerSet = () => { if(!isPomoRunning){ let v = parseInt(document.getElementById('timerSet').value); if (isNaN(v) || v < 1) v = 30; document.getElementById('timerDisplay').innerText = `${v}:00`; } };
    window.adjustTimer = (val) => {
        if(isPomoRunning) return;
        const inp = document.getElementById('timerSet');
        let current = parseInt(inp.value) || 30;
        let next = current + val;
        if(next < 5) next = 5;
        if(next > 120) next = 120;
        inp.value = next;
        updateTimerSet();
    };

    window.startPomoTimer = async () => { 
        if(isArenaRunning) { addToOwlQueue("HakanÄ±m! Meydanda cenk ederken sayacÄ± aÃ§amazsÄ±n! Ã–nce savaÅŸÄ± bitir. âš”ï¸"); return; }
        if(isPomoRunning) return; const sub = document.getElementById('pomoSubject').value; if(!sub) return Swal.fire("Ders SeÃ§", "", "warning"); 
        isPomoRunning = true; pomoTotalDuration = parseInt(document.getElementById('timerSet').value) * 60; pomoEndTime = Date.now() + (pomoTotalDuration * 1000); 
        document.getElementById('btnStartPomo').innerText = "â³"; document.getElementById('btnStartPomo').disabled = true; 
        try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); } } catch (err) {} 
        pomoInterval = setInterval(() => { 
            const rem = Math.ceil((pomoEndTime - Date.now()) / 1000); 
            if(rem <= 0) { document.getElementById('timerDisplay').innerText = "00:00"; clearInterval(pomoInterval); finishPomo(true); } 
            else { const m = Math.floor(rem / 60); const s = rem % 60; document.getElementById('timerDisplay').innerText = `${m}:${s.toString().padStart(2,'0')}`; } 
        }, 1000); 
    };
    window.requestStopPomo = () => { if(isPomoRunning) Swal.fire({ title: 'Durdur?', showCancelButton: true }).then((r) => { if (r.isConfirmed) { clearInterval(pomoInterval); finishPomo(false); } }); };
    async function finishPomo(completed) { 
        if(wakeLock) { wakeLock.release(); wakeLock = null; } 
        const sub = document.getElementById('pomoSubject').value; const spent = completed ? pomoTotalDuration : Math.ceil((pomoTotalDuration - (pomoEndTime - Date.now())/1000)); const mins = Math.floor(spent / 60); 
        isPomoRunning = false; document.getElementById('btnStartPomo').innerText = "BAÅLAT â–¶"; document.getElementById('btnStartPomo').disabled = false; document.getElementById('timerDisplay').innerText = `${document.getElementById('timerSet').value}:00`; 
        if(mins < 5) return Swal.fire("Ã‡ok KÄ±sa", "En az 5 dakika odaklanmalÄ±sÄ±n.", "info"); 
        let multiplier = 1.5; if (window.userClanId) multiplier += 0.5; const pts = Math.ceil(mins * multiplier); 
        await addDoc(collection(db,"users",currentUser.uid,"sessions"), { subject: sub, duration: mins, points: pts, createdAt: serverTimestamp(), type: 'pomodoro', completed: completed }); 
        await updateDoc(doc(db,"users",currentUser.uid), { totalMinutes: increment(mins), xp: increment(pts), gold: increment(pts), lastStudyDate: serverTimestamp() }); 
        Swal.fire("Bitti!", `${mins} dk Ã§alÄ±ÅŸtÄ±n. +${pts} Ã‡alÄ±ÅŸma YÄ±ldÄ±z PuanÄ±`, "success"); confetti(); await addClanPoints(currentUser.uid, pts); await checkStreakAndAward(currentUser.uid); 
    }
    
    async function checkStreakAndAward(uid) {
        const uSnap = await getDoc(doc(db, "users", uid)); const u = uSnap.data();
        const lastDate = u.lastStudyDate ? u.lastStudyDate.toDate() : new Date(0); const now = new Date();
        const isSameDay = lastDate.toDateString() === now.toDateString(); const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const isYesterday = lastDate.toDateString() === yesterday.toDateString();
        let newStreak = u.streak || 0;
        if (!isSameDay) {
            if (isYesterday) { newStreak++; } else { newStreak = 1; }
            if(newStreak > 0 && newStreak < 7) { let motivMsg = `HarikasÄ±n! ${newStreak}. gÃ¼nÃ¼ devirdin.`; addToOwlQueue(motivMsg); }
            if (newStreak >= 7) {
                newStreak = 0; await updateDoc(doc(db, "users", uid), { xp: increment(400), gold: increment(400) });
                await addDoc(collection(db,"users",uid,"sessions"), { subject: "7 GÃ¼nlÃ¼k Seri ğŸ”¥", duration: 0, points: 400, createdAt: serverTimestamp(), type: 'bonus', dateStr: new Date().toLocaleDateString('tr-TR') });
                addToOwlQueue("SERÄ° TAMAMLANDI! ğŸ”¥ +400 Puan!"); Swal.fire("SERÄ° ZAFERÄ°!", "+400 Puan HesabÄ±nda!", "success"); confetti();
            }
            await updateDoc(doc(db, "users", uid), { streak: newStreak });
        }
    }

    // --- ARENA (BEKLEME / SAVAÅ MODU) ---
    function listenArena() { 
        const q = query(collection(db, "arena"), where("isActive", "==", true)); 
        onSnapshot(q, (snap) => { 
            const list = document.getElementById('arenaList'); list.innerHTML = ""; activeGladiators = 0;
            let otherGladiatorsCount = 0;
            snap.forEach(d => { 
                const data = d.data(); const lastBeat = data.lastHeartbeat ? data.lastHeartbeat.toDate().getTime() : 0; const now = new Date().getTime(); 
                if (now - lastBeat > 3 * 60 * 1000) return; 
                if(d.id !== currentUser.uid) { 
                    otherGladiatorsCount++; 
                    list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${data.avatar} ${data.name.split(' ')[0]}</span><span style="font-weight:bold; color:var(--primary);">${data.state === 'waiting' ? 'Pusuda ğŸ›¡ï¸' : 'SavaÅŸÄ±yor âš”ï¸'}</span></div>`; 
                } 
            }); 
            activeGladiators = otherGladiatorsCount;
            if(list.innerHTML === "") list.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Meydan sessiz... Bir yiÄŸit bekleniyor.</div>";
            
            // EÄŸer ben bekliyorsam ve biri geldiyse savaÅŸÄ± baÅŸlat
            if (isArenaWaiting && otherGladiatorsCount > 0) { startActualArenaTimer(); }
        }); 
    }
    window.listenArena = listenArena;

    window.startArenaSession = async () => { 
        if(!currentUser) return; 
        if(isPomoRunning) { addToOwlQueue("Bilge! Odaklanma sÃ¼rerken savaÅŸa giremezsin!"); return; }
        
        document.getElementById('arenaStartBtn').classList.add('hidden'); 
        document.getElementById('arenaControls').classList.remove('hidden'); 
        
        // PUSU MODU BAÅLANGICI
        isArenaWaiting = true; 
        const timerDisplay = document.getElementById('arenaTimerDisplay');
        timerDisplay.classList.add('text-mode-timer'); // YAZI BOYUTUNU KÃœÃ‡ÃœLT (MOBÄ°L Ä°Ã‡Ä°N)
        timerDisplay.innerText = "RAKÄ°P BEKLENÄ°YOR..."; 
        
        await setDoc(doc(db, "arena", currentUser.uid), { name: currentUser.displayName, subject: "Genel", startTime: serverTimestamp(), duration: 30, isActive: true, state: 'waiting', avatar: document.getElementById('userAvatar').innerText, lastHeartbeat: serverTimestamp() }); 
        
        try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); } } catch (err) { console.log("Ekran kilidi kullanÄ±lamÄ±yor (Sorun deÄŸil)."); } 
        
        // Bekleme dÃ¶ngÃ¼sÃ¼ (Sadece heartbeat atar)
        arenaInterval = setInterval(async () => { 
            updateDoc(doc(db, "arena", currentUser.uid), { lastHeartbeat: serverTimestamp() }).catch(()=>{}); 
        }, 5000); 
    };
    
    function startActualArenaTimer() { 
        if (!isArenaWaiting) return; 
        isArenaWaiting = false; 
        isArenaRunning = true; 
        
        const timerDisplay = document.getElementById('arenaTimerDisplay');
        timerDisplay.classList.remove('text-mode-timer'); // YAZI BOYUTUNU NORMALE DÃ–NDÃœR
        timerDisplay.innerText = "30:00"; 
        
        Swal.fire({ title: 'DÃœÅMAN GÃ–RÃœNDÃœ!', text: 'SavaÅŸ baÅŸladÄ±! KÄ±lÄ±cÄ±n keskin olsun!', icon: 'warning', timer: 1500, showConfirmButton: false }); 
        
        // Durumu gÃ¼ncelle
        updateDoc(doc(db, "arena", currentUser.uid), { state: 'fighting' }); 
        
        arenaTotalDuration = 30 * 60; 
        arenaEndTime = Date.now() + (arenaTotalDuration * 1000); 
        
        clearInterval(arenaInterval); 
        arenaInterval = setInterval(async () => { 
            // HER SANÄ°YE KONTROL: RAKÄ°P VAR MI?
            if (activeGladiators === 0) {
                clearInterval(arenaInterval);
                finishArena(false); // SavaÅŸ iptal
                Swal.fire("SAVAÅ Ä°PTAL", "TÃ¼m rakipler meydanÄ± terk etti! Tek baÅŸÄ±na savaÅŸ olmaz.", "error");
                return;
            }

            const rem = Math.ceil((arenaEndTime - Date.now()) / 1000); 
            if(rem % 5 === 0) { updateDoc(doc(db, "arena", currentUser.uid), { lastHeartbeat: serverTimestamp() }).catch(()=>{}); } 
            
            if(rem <= 0) { 
                document.getElementById('arenaTimerDisplay').innerText = "00:00"; 
                clearInterval(arenaInterval); 
                finishArena(true); 
            } else { 
                const m = Math.floor(rem / 60); 
                const s = rem % 60; 
                document.getElementById('arenaTimerDisplay').innerText = `${m}:${s.toString().padStart(2,'0')}`; 
            } 
        }, 1000); 
    }

    window.boostArenaTime = () => { if(isArenaWaiting) return Swal.fire("SabÄ±r!", "HenÃ¼z savaÅŸ baÅŸlamadÄ±.", "warning"); if(isArenaRunning) { arenaEndTime += 600000; arenaTotalDuration += 600; Swal.fire("+10 Dk", "", "success"); updateDoc(doc(db,"arena",currentUser.uid),{duration:increment(10)}); } };
    
    // --- PES ET BUTONU MANTIÄI ---
    window.requestStopArena = () => { 
        if (isArenaWaiting) {
            // Beklerken pes ederse ceza yok, sadece Ã§Ä±k.
            clearInterval(arenaInterval);
            finishArena(false);
        } else if (isArenaRunning) {
            // SavaÅŸÄ±rken pes ederse yenilgi.
            Swal.fire({ title: 'Ã‡Ä±kÄ±ÅŸ?', showCancelButton: true }).then((r) => { if (r.isConfirmed) { clearInterval(arenaInterval); finishArena(false); } }); 
        }
    };
    
    async function finishArena(completed) { 
        // ğŸ›‘ KRÄ°TÄ°K GÃœVENLÄ°K DÃœZELTMESÄ°: EÄER ZATEN BÄ°TTÄ°YSE Ã‡IK
        if (!isArenaWaiting && !isArenaRunning) return;

        if(wakeLock) { try{wakeLock.release();}catch(e){} wakeLock = null; } 
        
        const wasFighting = isArenaRunning;
        
        // DeÄŸiÅŸkenleri sÄ±fÄ±rla
        isArenaWaiting = false; 
        isArenaRunning = false;
        clearInterval(arenaInterval); 
        
        document.getElementById('arenaStartBtn').classList.remove('hidden'); 
        document.getElementById('arenaControls').classList.add('hidden'); 
        document.getElementById('arenaTimerDisplay').innerText = "00:00"; 
        
        try{ await updateDoc(doc(db, "arena", currentUser.uid), { isActive: false }); }catch(e){} 
        
        // EÄŸer hiÃ§ savaÅŸmadÄ±ysa veya tamamlamadÄ±ysa (Pes ettiyse) PUAN YOK
        if (!wasFighting || !completed) return; 

        // Puan Hesaplama
        const spent = Math.floor((arenaTotalDuration) / 60); 
        if(spent < 5) return Swal.fire("Ã‡ok KÄ±sa", "En az 5 dakika durmalÄ±sÄ±n.", "info"); 
        
        let multiplier = 2.0; 
        if (window.userClanId) multiplier += 0.5; 
        const pts = Math.ceil(spent * multiplier); 
        
        await addDoc(collection(db,"users",currentUser.uid,"sessions"), { subject: "Arena", duration: spent, points: pts, createdAt: serverTimestamp(), type: 'arena', completed: completed }); 
        await updateDoc(doc(db,"users",currentUser.uid), { totalMinutes: increment(spent), xp: increment(pts), gold: increment(pts) }); 
        
        Swal.fire("Bitti!", `${spent} dk, +${pts} Puan`, "success"); 
        await addClanPoints(currentUser.uid, pts); 
        await checkStreakAndAward(currentUser.uid); 
    }
    
    document.addEventListener("visibilitychange", async () => { 
        if (document.visibilityState === 'visible') { 
            if (isPomoRunning && pomoEndTime > 0 && Date.now() >= pomoEndTime) { clearInterval(pomoInterval); await finishPomo(true); } 
            if (isArenaRunning && arenaEndTime > 0 && Date.now() >= arenaEndTime) { clearInterval(arenaInterval); await finishArena(true); } 
            try { if ('wakeLock' in navigator && (isPomoRunning || isArenaRunning)) { if (wakeLock === null || wakeLock.released) { wakeLock = await navigator.wakeLock.request('screen'); } } } catch(e){} 
        } 
    });

    // --- GÃœNCELLENMÄ°Å OTAÄ KONTROLÃœ (AtÄ±lma Durumu Ä°Ã§in) ---
    async function checkClanStatus(uid) { 
        const u = (await getDoc(doc(db, "users", uid))).data(); 
        window.userClanId = u.clanId || null; 
        
        if (u.clanId) { 
            const cSnap = await getDoc(doc(db, "clans", u.clanId));
            if(cSnap.exists()){
                const c = cSnap.data(); 
                document.getElementById('noClanSection').classList.add('hidden'); 
                document.getElementById('myClanSection').classList.remove('hidden'); 
                document.getElementById('myClanName').innerText = c.name; 
                document.getElementById('myClanIcon').innerText = c.icon; 
                document.getElementById('myClanScore').innerText = c.totalScore || 0; 
                loadMyClanMembers(u.clanId);
            } else {
                document.getElementById('noClanSection').classList.remove('hidden'); 
                document.getElementById('myClanSection').classList.add('hidden'); 
                loadJoinableClans();
            }
        } else { 
            document.getElementById('noClanSection').classList.remove('hidden'); 
            document.getElementById('myClanSection').classList.add('hidden'); 
            
            // BEKLEYEN Ä°STEK VAR MI?
            const qPending = query(collection(db, "clan_requests"), where("leader", "==", uid));
            const snap = await getDocs(qPending);
            
            const createBtn = document.getElementById('btnCreateClan');
            if(!snap.empty && createBtn) {
                const reqData = snap.docs[0].data();
                createBtn.disabled = true;
                createBtn.innerHTML = `â³ "${reqData.name}" OtaÄŸÄ± Ä°Ã§in Onay Bekleniyor`;
                createBtn.style.background = "#94a3b8";
                createBtn.onclick = null;
            } else if(createBtn) {
                createBtn.disabled = false;
                createBtn.innerHTML = `OtaÄŸ Kurma Ä°steÄŸi GÃ¶nder`;
                createBtn.style.background = "var(--primary)";
                // DÃœZELTÄ°LDÄ°: ArtÄ±k tanÄ±mlanmÄ±ÅŸ fonksiyonu Ã§aÄŸÄ±rÄ±yor
                createBtn.onclick = () => window.openCreateClanModal();
            }

            loadJoinableClans(); 
        } 
        loadClanLeaderboard(); 
    }

    async function loadMyClanMembers(cid) { const q = query(collection(db, "users"), where("clanId", "==", cid)); const snap = await getDocs(q); document.getElementById('myClanMembers').innerText = snap.size; let html = ""; 
    // GÃœNCELLEME: Puan GÃ¶sterimi
    snap.forEach(d => { 
        const u = d.data();
        html += `<div style="padding:5px 0; border-bottom:1px solid #f1f5f9; font-size:0.9rem; display:flex; justify-content:space-between;">
            <span>ğŸ‘¤ ${u.displayName}</span>
            <span style="font-weight:bold; color:#6366f1;">${u.xp || 0} âœ¨</span>
        </div>`; 
    }); 
    document.getElementById('myClanMemberList').innerHTML = html || "<small>Kimse yok.</small>"; }

    // --- DÃœZELTME: OtaÄŸ SÄ±ralamasÄ± Temizleme ---
    async function loadClanLeaderboard() { 
        const list = document.getElementById('clanLeaderboard'); 
        if(!list) return;
        
        // Ã–nceki dinleyiciyi kapat (varsa) - Ã‡Ä°FTE GÃ–STERÄ°MÄ° Ã–NLER
        if(unsubClanLeaderboard) { unsubClanLeaderboard(); unsubClanLeaderboard = null; }

        list.innerHTML = "Veriler Ã§ekiliyor...";
        
        const q = query(collection(db, "clans"), orderBy("totalScore", "desc"), limit(5)); 
        
        unsubClanLeaderboard = onSnapshot(q, (snap) => {
            list.innerHTML = ""; // HER SEFERÄ°NDE LÄ°STEYÄ° TEMÄ°ZLE
            
            if(snap.empty) {
                list.innerHTML = "HenÃ¼z OtaÄŸ yok.";
                return;
            }

            snap.docs.forEach((d,i)=>{ 
                const data = d.data(); 
                list.innerHTML += `<div style="margin-bottom:5px; font-weight:600; padding:5px; border-bottom:1px solid #eee;">#${i+1} ${data.icon} ${data.name} <span style="float:right; color:var(--primary);">${data.totalScore || 0} P</span></div>`; 
            }); 
        });
    }

    async function addClanPoints(uid, points) { const u = (await getDoc(doc(db, "users", uid))).data(); if(u.clanId) await updateDoc(doc(db,"clans",u.clanId), { totalScore: increment(points) }); }
    
    // --- MODAL FONKSÄ°YONLARI ---

    window.openCreateClanModal = () => {
        document.getElementById('newClanName').value = "";
        document.getElementById('modalCreateClan').classList.remove('hidden');
    };

    window.selectClanIcon = (el) => {
        document.querySelectorAll('#clanIconSelect .chip-modern').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        const iconChar = el.querySelector('span').innerText;
        document.getElementById('selectedClanIcon').value = iconChar;
    };

    window.createClanRequest = async () => { 
        if (!currentUser) return Swal.fire("Hata", "Oturum bilgisi alÄ±namadÄ±. LÃ¼tfen sayfayÄ± yenileyip tekrar giriÅŸ yap.", "error");

        const clanName = document.getElementById('newClanName').value.trim();
        const clanIcon = document.getElementById('selectedClanIcon').value;

        if(clanName.length < 3) return Swal.fire("Hata", "OtaÄŸ adÄ± en az 3 harf olmalÄ±.", "warning");

        const ruleCheck = await Swal.fire({
            title: 'ğŸ“œ OTAÄ KURMA YEMÄ°NÄ°',
            html: `
                <div style="text-align:left; font-size:0.9rem; line-height:1.5;">
                    <p>Ey Alp! Yeni bir sancak aÃ§mak Ã¼zeresin. Åu kurallarÄ± kabul ediyor musun?</p>
                    <ul style="margin-bottom:10px;">
                        <li>âš”ï¸ <strong>Adalet:</strong> OtaÄŸÄ±n sÄ±nÄ±f mevcudunun 5'te 1'ini geÃ§emez.</li>
                        <li>ğŸ¤ <strong>KardeÅŸlik:</strong> OtaÄŸÄ±ndaki her Alpten sorumlusun.</li>
                        <li>âš–ï¸ <strong>DÃ¼rÃ¼stlÃ¼k:</strong> Asla hile yapmayacak, hak etmediÄŸin puanÄ± almayacaksÄ±n.</li>
                    </ul>
                    <p style="color:#c2410c; font-weight:bold;">Hakan (YÃ¶netici) onaylamadan OtaÄŸ kurulmaz.</p>
                </div>
            `,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'SÃ–Z VERÄ°YORUM âœ…',
            cancelButtonText: 'VAZGEÃ‡',
            confirmButtonColor: '#009688',
            cancelButtonColor: '#ef4444'
        });

        if (!ruleCheck.isConfirmed) return;

        const btn = document.querySelector('#modalCreateClan .btn-action'); 
        if(btn) { btn.innerText = "Ä°letiliyor..."; btn.disabled = true; }
        
        try { 
            const q1 = query(collection(db, "clan_requests"), where("leader", "==", currentUser.uid)); 
            const snap1 = await getDocs(q1); 
            if (!snap1.empty) {
                 Swal.fire("SabÄ±rlÄ± Ol", "Zaten Hakan'a ilettiÄŸin bir otaÄŸ kurma isteÄŸin var. Haber bekle.", "warning"); 
                 return;
            }
            
            const q2 = query(collection(db, "member_requests"), where("userId", "==", currentUser.uid)); 
            const snap2 = await getDocs(q2); 
            if (!snap2.empty) return Swal.fire("Karar Ver", "Åu an baÅŸka bir otaÄŸa katÄ±lma isteÄŸin beklemede. Ä°ki ipte oynanmaz.", "warning"); 
            
            await addDoc(collection(db,"clan_requests"), { 
                name: clanName, 
                icon: clanIcon, 
                leader: currentUser.uid, 
                leaderName: currentUser.displayName || "Ä°simsiz Alp",
                createdAt: serverTimestamp() 
            }); 
            
            Swal.fire("Arz Edildi", "OtaÄŸ kurma isteÄŸin ve yeminin Hakan'a iletildi.", "success"); 
            document.getElementById('modalCreateClan').classList.add('hidden'); 
            checkClanStatus(currentUser.uid); // EkranÄ± gÃ¼ncelle
        } catch (error) { 
            console.error(error); 
            Swal.fire("Hata", "Ä°stek gÃ¶nderilirken sorun oluÅŸtu: " + error.message, "error"); 
        } finally { 
            if(btn) { btn.innerText = "HAKANA ARZ ET"; btn.disabled = false; } 
        } 
    }; 
    
    window.leaveClan=async()=>{const u=(await getDoc(doc(db,"users",currentUser.uid))).data(); await updateDoc(doc(db,"clans",u.clanId),{memberCount:increment(-1)}); await updateDoc(doc(db,"users",currentUser.uid),{clanId:deleteField()}); checkClanStatus(currentUser.uid);};
    function checkTimeCapsule(uid) { const q = query(collection(db, "users", uid, "timecapsule"), orderBy("createdAt", "desc"), limit(1)); onSnapshot(q, (snap) => { const inputArea = document.getElementById('capsuleInputArea'); const lockedArea = document.getElementById('capsuleLocked'); const openArea = document.getElementById('capsuleOpen'); if (!snap.empty) { const data = snap.docs[0].data(); const unlockDateStr = data.unlockDate || "2026-01-10"; document.getElementById('capsuleUnlockDisplay').innerText = unlockDateStr; if (new Date() < new Date(unlockDateStr)) { lockedArea.classList.remove('hidden'); openArea.classList.add('hidden'); inputArea.classList.add('hidden'); } else { lockedArea.classList.add('hidden'); openArea.classList.remove('hidden'); inputArea.classList.add('hidden'); document.getElementById('capsuleContentText').innerText = data.content; } } else { inputArea.classList.remove('hidden'); lockedArea.classList.add('hidden'); openArea.classList.add('hidden'); document.getElementById('capsuleUnlockDisplay').innerText = "HenÃ¼z KapsÃ¼l Yok"; } }); }
    window.saveFuture = async () => { const btn = document.getElementById('btnSaveFuture'); const msg = document.getElementById('futureMsg').value.trim(); if(!msg || msg.length < 10) return Swal.fire("Eksik Mesaj", "LÃ¼tfen en az bir cÃ¼mlelik tam mesaj yazÄ±nÄ±z.", "warning"); btn.disabled = true; btn.innerText = "MÃ¼hÃ¼rleniyor..."; try { const q = query(collection(db, "users", currentUser.uid, "timecapsule")); const snap = await getDocs(q); if (!snap.empty) { btn.disabled = false; btn.innerText = "MÃœHÃœRLE VE GÃ–NDER ğŸ”’"; return Swal.fire("Zaten Var", "Sadece 1 kapsÃ¼l hakkÄ±n var.", "warning"); } await addDoc(collection(db,"users",currentUser.uid,"timecapsule"), { content: msg, createdAt: serverTimestamp(), unlockDate: "2026-01-10", userId: currentUser.uid, userName: currentUser.displayName }); await addDoc(collection(db,"users",currentUser.uid,"sessions"), { subject: "Zaman KapsÃ¼lÃ¼ âœ‰ï¸", duration: 0, points: 200, createdAt: serverTimestamp(), type: 'bonus', dateStr: new Date().toLocaleDateString('tr-TR') }); await updateDoc(doc(db,"users",currentUser.uid), { xp: increment(200), gold: increment(200) }); Swal.fire("MÃ¼hÃ¼rlendi", `MesajÄ±n geleceÄŸe yollandÄ±! +200 Ã‡alÄ±ÅŸma YÄ±ldÄ±z PuanÄ± kazandÄ±n!`, "success"); confetti(); } catch(e) { console.error(e); Swal.fire("Hata", "KapsÃ¼l oluÅŸturulamadÄ±.", "error"); btn.disabled = false; btn.innerText = "MÃœHÃœRLE VE GÃ–NDER ğŸ”’"; } };

    function listenStudentMessages(uid){ 
        onSnapshot(query(collection(db, "messages"), where("toUid", "==", uid)), s=>{ 
            let ur=0; 
            const list=document.getElementById('msgList'); 
            list.innerHTML=""; 
            const msgs = []; 
            s.forEach(d => msgs.push({id:d.id, ...d.data()})); 
            msgs.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)); 
            
            if (msgs.length === 0) list.innerHTML = "<div style='text-align:center; padding:20px; color:#aaa;'>Mesaj yok.</div>"; 
            
            msgs.forEach(m => { 
                if(!m.read) ur++; 
                const msgType=m.type||'auto'; 
                const icon=msgType==='admin'?'ğŸ‘¨â€ğŸ«':'ğŸ¦‰'; 
                const sender=msgType==='admin'?'Hakan':'Sistem'; 
                const dateStr = formatDateTR(m.createdAt); 
                
                list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; background:${m.read?'white':'#f0fdf4'}; border-radius:10px; margin-bottom:5px;" onclick="readMsg('${m.id}')"><strong>${icon} ${sender}</strong> <span style="font-size:0.7rem; color:#888;">${dateStr}</span><br> ${m.content} ${!m.read?'<span style="color:red; font-size:0.7rem;">(YENÄ°)</span>':''}</div>`; 
            }); 
            
            const bd = document.getElementById('coachBadge'); 
            const av = document.getElementById('wiseAvatar'); 
            bd.innerText = ur; 
            
            if (ur > 0) { 
                bd.classList.remove('hidden'); 
                av.style.transform="scale(1.2)"; 
                
                // GÃœNCELLEME: Yeni mesaj varsa baloncuk gÃ¶ster
                const bubble = document.getElementById('coachBubble');
                const owlText = document.getElementById('owlMsgText');
                if(msgs.length > 0 && !msgs[0].read) {
                    owlText.innerText = "Hakan'dan Mesaj Var! ğŸ¦‰";
                    bubble.classList.add('show');
                    setTimeout(()=>bubble.classList.remove('show'), 5000);
                }
            } else { 
                bd.classList.add('hidden'); 
                av.style.transform="scale(1)"; 
            } 
        }); 
    }
    window.readMsg = async(id) => { await updateDoc(doc(db,"messages",id),{read:true}); }; window.openMsgModal = () => document.getElementById('modalMsg').classList.remove('hidden');
    window.changeStudentGoal = async () => { const currentGoal = document.getElementById('targetMins').innerText; const { value: newGoal } = await Swal.fire({ title: 'HaftalÄ±k Hedef', input: 'number', inputValue: currentGoal, inputLabel: 'KaÃ§ dakika Ã§alÄ±ÅŸacaksÄ±n?', showCancelButton: true, confirmButtonText: 'GÃ¼ncelle', inputValidator: (v) => (!v || v < 500) && 'Hedef en az 500 dakika olmalÄ±dÄ±r! Daha azÄ± bir Alpe yakÄ±ÅŸmaz.' }); if (newGoal) { const goalInt = parseInt(newGoal); await updateDoc(doc(db, "users", currentUser.uid), { weeklyGoal: goalInt }); document.getElementById('targetMins').innerText = goalInt; Swal.fire("Hedef GÃ¼ncellendi", `Yeni hedefin: ${goalInt} dk.`, "success"); } };
    window.switchTab=(t,el)=>{ if(el) { document.querySelectorAll('.mobile-bottom-nav .nav-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); } ['viewHome','viewPomo','viewStore','viewFuture','viewHistory', 'viewArena', 'viewClan', 'viewDesc'].forEach(x=>document.getElementById(x).classList.add('hidden')); document.getElementById('view'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden'); if(t === 'arena') listenArena(); if(t === 'clan') { loadClanLeaderboard(); } };
    window.openProfileModal=()=>{document.getElementById('editProfileName').value=currentUser.displayName||"";document.getElementById('modalProfile').classList.remove('hidden')}; window.saveUserProfile=async()=>{await updateProfile(currentUser,{displayName:document.getElementById('editProfileName').value}); await updateDoc(doc(db,"users",currentUser.uid),{displayName:document.getElementById('editProfileName').value}); location.reload();};
    
    document.addEventListener('contextmenu', event => event.preventDefault()); document.onkeydown = function(e) { if(e.keyCode == 123) return false; if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false; if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false; if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; }
    window.deleteDoc=deleteDoc; window.doc=doc; window.db=db; window.readMsg=window.readMsg; window.openMsgModal=window.openMsgModal;

    async function getClanLimit() { return 5; }

    window.loadJoinableClans = async () => { 
        const list = document.getElementById('clanJoinList'); list.innerHTML = "YÃ¼kleniyor..."; 
        const q = query(collection(db, "clans"), orderBy("totalScore", "desc"), limit(5)); const querySnapshot = await getDocs(q); const limitCount = await getClanLimit(); list.innerHTML = "";
        querySnapshot.forEach(d => { 
            const data = d.data(); const count = data.memberCount || 1; const isFull = count >= limitCount; let btnHtml = '';
            if (isFull) { btnHtml = `<button disabled style="background:#e2e8f0; color:#94a3b8; cursor:not-allowed;">DOLU (${count}/${limitCount})</button>`; } 
            else { btnHtml = `<button onclick="joinClanRequest('${d.id}','${data.name}')">KatÄ±l (${count}/${limitCount})</button>`; }
            list.innerHTML += `<div>${data.icon} ${data.name} ${btnHtml}</div>`; 
        }); 
        if(list.innerHTML === "") list.innerHTML = "<small>HenÃ¼z kurulmuÅŸ bir OtaÄŸ yok.</small>";
    }
    
    window.joinClanRequest = async (cid, cname) => { 
        try { 
            const q1 = query(collection(db, "member_requests"), where("userId", "==", currentUser.uid)); const snap1 = await getDocs(q1); 
            if (!snap1.empty) { const pending = snap1.docs[0].data(); if(pending.clanId === cid) return Swal.fire("Zaten SÄ±radasÄ±n", "Zaten haber gÃ¶nderdin. Bekle.", "info"); else return Swal.fire("Sadakat Ã–nemlidir", "Åu an '" + pending.clanName + "' iÃ§in bekliyorsun. AynÄ± anda iki kapÄ± Ã§alÄ±nmaz.", "warning"); } 
            const q2 = query(collection(db, "clan_requests"), where("leader", "==", currentUser.uid)); const snap2 = await getDocs(q2); 
            if (!snap2.empty) return Swal.fire("Ã‡eliÅŸki", "Kendi otaÄŸÄ±nÄ± kurmak iÃ§in baÅŸvurmuÅŸsun. BaÅŸkasÄ±na giremezsin.", "warning"); 
            const clanSnap = await getDoc(doc(db, "clans", cid)); if (!clanSnap.exists()) return Swal.fire("Hata", "BÃ¶yle bir otaÄŸ yok.", "error");
            const clanData = clanSnap.data(); const currentCount = clanData.memberCount || 1; const maxLimit = await getClanLimit();
            if (currentCount >= maxLimit) { return Swal.fire("OtaÄŸ Dolu", `Bu otaÄŸ maksimum kapasiteye (${maxLimit} Alp) ulaÅŸmÄ±ÅŸ. BaÅŸka bir otaÄŸ seÃ§melisin.`, "error"); }
            await addDoc(collection(db,"member_requests"), { clanId: cid, clanName: cname, userId: currentUser.uid, userName: currentUser.displayName }); 
            Swal.fire("Haber SalÄ±ndÄ±", cname + " otaÄŸÄ±na katÄ±lma isteÄŸin iletildi.", "success"); 
        } catch (error) { console.error(error); Swal.fire("Hata", "Ä°stek gÃ¶nderilemedi.", "error"); } 
    }; 
</script>
</body>
</html>