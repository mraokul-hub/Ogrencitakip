<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ã–ÄŸrenci Takip Sistemi</title>
    
    <link rel="icon" href="Designer (1).jpg" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4338ca; --secondary: #ec4899;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
            --bg-gradient: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #1e293b; --text-sub: #64748b; --radius: 24px;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-gradient); margin: 0; padding: 20px 15px; min-height: 100vh; color: var(--text-main); display: flex; justify-content: center; }
        
        .container { width: 100%; max-width: 460px; padding-bottom: 90px; }
        .container.admin-mode { max-width: 1000px; } /* Admin ekranÄ± geniÅŸletildi */

        .card {
            background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 24px; margin-bottom: 24px; transition: transform 0.2s;
        }
        
        h2, h3 { margin: 0 0 10px 0; color: var(--primary-dark); letter-spacing: -0.5px; }
        h4 { margin: 0 0 15px 0; font-weight: 800; color: var(--text-sub); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }

        input, select { width: 100%; padding: 16px; margin-bottom: 12px; border: 2px solid transparent; border-radius: 16px; font-size: 1rem; background: #f1f5f9; color: var(--text-main); transition: 0.3s; font-family: inherit; font-weight: 500; }
        input:focus, select:focus { border-color: var(--primary); background: #fff; outline: none; }
        button { width: 100%; padding: 16px; border: none; border-radius: 16px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: 0.2s; font-family: inherit; }
        button:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4); }
        .btn-logout-distinct { background: #fee2e2; color: var(--danger); padding: 8px 16px; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.85rem; width: auto; border: 1px solid #fca5a5; }
        .btn-profile-settings { background: #f1f5f9; width: 36px; height: 36px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; border:none; color:var(--text-sub); }

        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .tabs { display: flex; background: #e0e7ff; padding: 5px; border-radius: 18px; margin-bottom: 24px; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 14px; font-weight: 600; color: var(--text-sub); transition: 0.3s; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        .chips { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        .chip { background: white; padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: 1px solid #e2e8f0; color: var(--text-sub); }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .chip-edit { background: #fffbeb; color: var(--warning); border-color: #fcd34d; }

        .timer-display { font-size: 4.5rem; font-weight: 800; text-align: center; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 10px 0; font-variant-numeric: tabular-nums; letter-spacing: -3px; }
        .timer-controls { display: flex; gap: 12px; margin-bottom: 20px; }
        .btn-start { background: var(--success); color: white; }
        .btn-stop { background: var(--danger); color: white; }
        
        .streak-badge { background: linear-gradient(135deg, #fff7ed, #ffedd5); color: #c2410c; padding: 6px 14px; border-radius: 20px; font-weight: 800; display: flex; align-items: center; gap: 6px; font-size: 0.85rem; border: 1px solid #fed7aa; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-radius: 16px; margin-bottom: 8px; background: #fff; border: 1px solid #f1f5f9; }
        .btn-action { width: 34px; height: 34px; padding: 0; border-radius: 10px; font-size: 1rem; margin-left: 6px; display: inline-flex; align-items: center; justify-content: center; }
        .btn-edit { background: #e0e7ff; color: var(--primary); } .btn-delete { background: #fee2e2; color: var(--danger); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 30px; width: 90%; max-width: 450px; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border: 1px solid rgba(255,255,255,0.5); }
        .hidden { display: none !important; }
        .chart-wrapper { position: relative; height: 220px; width: 100%; display: flex; justify-content: center; margin-top: 15px; }
        .error-box { background-color: #fee2e2; color: #b91c1c; padding: 14px; border-radius: 14px; font-size: 0.9rem; margin-top: 15px; display: none; text-align: center; border: 1px solid #fecaca; }
        .time-btn-group { display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 8px; border-radius: 20px; margin-bottom: 24px; border: 1px solid #e2e8f0; }
        .btn-adjust { background: white; border: 1px solid #e2e8f0; color: var(--text-main); font-weight: 800; width: 45px; height: 45px; border-radius: 14px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .mood-selector { display: flex; gap: 12px; margin-bottom: 24px; }
        .mood-btn { flex: 1; padding: 16px 5px; border: 2px solid transparent; border-radius: 18px; background: #fff; cursor: pointer; text-align: center; font-size: 1.8rem; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .mood-btn.selected { border-color: var(--primary); background: #eef2ff; transform: translateY(-3px); }
        .mood-text { display: block; font-size: 0.75rem; color: var(--text-sub); font-weight: 700; margin-top: 5px; }
        .question-inputs { display: flex; gap: 12px; margin: 20px 0; }
        .q-box { flex: 1; text-align: center; } .q-box label { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 6px; display: block; font-weight: 600; } .q-box input { text-align: center; font-weight: 700; margin-bottom: 0; background: #fff; border: 2px solid #e2e8f0; }

        /* --- ADMIN GÃ–RSEL Ä°YÄ°LEÅTÄ°RMELERÄ° --- */
        .admin-header { background: linear-gradient(135deg, #1e1b4b, #4338ca); padding: 24px; border-radius: 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 15px 30px rgba(30, 27, 75, 0.3); color:white; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 24px; }
        .kpi-card { background: white; padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; display: block; margin-bottom: 5px; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .kpi-label { font-size: 0.8rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }

        /* Scrollable Chart Container */
        .chart-scroll-container { width: 100%; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .chart-scroll-inner { height: 350px; min-width: 800px; /* Dinamik artacak */ }

        /* Student Table Enhancements */
        .student-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .student-table th { text-align: left; padding: 15px; color: var(--text-sub); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
        .student-table td { padding: 15px; background: white; font-size: 0.95rem; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .student-table tr { cursor: pointer; transition: transform 0.2s; }
        .student-table tr:hover { transform: scale(1.01); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); z-index: 10; position: relative; }
        .student-table tr td:first-child { border-top-left-radius: 16px; border-bottom-left-radius: 16px; border-left: 1px solid #f1f5f9; }
        .student-table tr td:last-child { border-top-right-radius: 16px; border-bottom-right-radius: 16px; border-right: 1px solid #f1f5f9; }

        /* Smart Badges */
        .smart-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; }
        .sb-star { background: #fff7ed; color: #d97706; border: 1px solid #fcd34d; }
        .sb-good { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .sb-risk { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .sb-idle { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }

        /* Rising Stars Section */
        .rising-stars { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 20px; }
        .star-card { min-width: 140px; background: linear-gradient(135deg, #fff, #fdfbf7); padding: 15px; border-radius: 18px; border: 1px solid #fef3c7; box-shadow: 0 4px 6px rgba(0,0,0,0.02); text-align: center; }
        .star-icon { font-size: 2rem; margin-bottom: 5px; display: block; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        /* Guidance Modal Styling */
        .guidance-header { text-align: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 15px; }
        .guidance-score { font-size: 3rem; font-weight: 900; color: var(--primary); line-height: 1; }
        .guidance-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-sub); font-weight: 700; letter-spacing: 1px; }
        .ai-comment { background: #f8fafc; border-left: 4px solid var(--primary); padding: 15px; border-radius: 0 12px 12px 0; margin-bottom: 20px; font-style: italic; color: #475569; }
    </style>
</head>
<body>

<div class="container fade-in" id="mainContainer">

    <div id="authScreen" class="card" style="margin-top: 60px;">
        <div style="font-size: 4rem; text-align: center; margin-bottom: 15px;">ğŸ›¡ï¸</div>
        <h2 id="authTitle" style="text-align: center;">Ã–ÄŸrenci Takip</h2>
        <p style="text-align:center; color:var(--text-sub); font-size:0.95rem; margin-bottom:30px;">
            GeleceÄŸin lideri, Ã§alÄ±ÅŸma masana hoÅŸ geldin.
        </p>
        <input type="text" id="regStudentName" placeholder="Ã–ÄŸrenci AdÄ± SoyadÄ±" class="hidden">
        <input type="email" id="email" placeholder="E-Posta Adresi" required>
        <input type="password" id="password" placeholder="Åifre" required>
        <button class="btn-primary" id="mainAuthBtn" onclick="handleLogin()">GÄ°RÄ°Å YAP</button>
        <div style="text-align:center; margin-top:20px; font-size:0.9rem; color:var(--primary); cursor:pointer; font-weight:600;" id="toggleText" onclick="toggleAuthMode()">
            HesabÄ±nÄ±z yok mu? KayÄ±t Olun
        </div>
        <div id="authError" class="error-box"></div>
    </div>

    <div id="dashboardScreen" class="hidden fade-in">
        <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding: 20px; background: rgba(255,255,255,0.9);">
            <div>
                <div style="display:flex; align-items:center;">
                    <h3 style="margin:0; text-align:left; font-size:1.3rem; color:var(--text-main);">Selam, <span id="studentNameDisplay" style="color:var(--primary);">Ã–ÄŸrenci</span></h3>
                    <button class="btn-profile-settings" onclick="openProfileModal()" title="Profil AyarlarÄ±">âš™ï¸</button>
                </div>
                <small style="color:var(--text-sub); font-weight:500;">Ä°yi Ã§alÄ±ÅŸmalar dileriz.</small>
            </div>
            <button class="btn-logout-distinct" onclick="handleLogout()" title="Oturumu Kapat">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                <h4>HAFTALIK Ä°LERLEME</h4>
                <div class="streak-badge" title="Zinciri KÄ±rma!">ğŸ”¥ <span id="streakCount">0</span> GÃ¼n</div>
            </div>
            <div class="chart-wrapper"><canvas id="weeklyChart"></canvas></div>
            <div style="text-align:center; font-size:0.95rem; color:var(--text-sub); margin: 20px 0;">
                Tamamlanan: <strong id="completedMins" style="color:var(--success); font-size:1.2rem;">0</strong> / <span id="targetMins">1000</span> dk
            </div>
            <div style="background:#f8fafc; padding:12px; border-radius:16px; display:flex; justify-content:space-between; align-items:center; border: 1px solid #e2e8f0;">
                <label style="font-size:0.9rem; color:var(--text-main); font-weight:600;">ğŸ¯ HaftalÄ±k Hedef (dk):</label>
                <input type="number" id="weeklyGoalInput" value="1000" onchange="updateGoal()" style="width:90px; margin:0; padding:10px; text-align:center; border:1px solid #cbd5e1; background:white;">
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('manual')" id="tabManual">âš¡ HÄ±zlÄ± GiriÅŸ</div>
                <div class="tab" onclick="switchTab('pomodoro')" id="tabPomodoro">â±ï¸ SayaÃ§lÄ±</div>
            </div>
            <div id="panelManual" class="fade-in">
                <label style="margin-bottom:10px; display:block; font-weight:600; font-size:0.85rem; color:var(--text-sub); letter-spacing:1px;">DERS SEÃ‡Ä°MÄ°</label>
                <div id="chipsManual" class="chips"></div>
                <input type="hidden" id="selectedSubject" value="">
                <label style="margin-bottom:10px; display:block; font-weight:600; font-size:0.85rem; color:var(--text-sub); letter-spacing:1px;">TARÄ°H</label>
                <select id="entryDateSelect" style="margin-bottom:20px;">
                    <option value="0" selected>ğŸ“… BugÃ¼n (Åimdi)</option>
                    <option value="1">âª DÃ¼n</option>
                    <option value="2">â®ï¸ Evvelsi GÃ¼n</option>
                </select>
                <label style="margin-bottom:10px; display:block; font-weight:600; font-size:0.85rem; color:var(--text-sub); letter-spacing:1px;">SÃœRE (DK)</label>
                <div class="time-btn-group">
                    <button class="btn-adjust" onclick="adjustTime(-10)">-</button>
                    <input type="number" id="duration" value="40" style="text-align:center; margin:0; font-weight:800; font-size:1.3rem; border:none; background:transparent;">
                    <button class="btn-adjust" onclick="adjustTime(10)">+</button>
                </div>
                <div class="mood-selector">
                    <div class="mood-btn" onclick="selectMood(this, 'Verimsiz')">ğŸ˜´<span class="mood-text">Az</span></div>
                    <div class="mood-btn" onclick="selectMood(this, 'Orta')">ğŸ˜<span class="mood-text">Orta</span></div>
                    <div class="mood-btn selected" onclick="selectMood(this, 'Verimli')">ğŸ”¥<span class="mood-text">Ã‡ok</span></div>
                </div>
                <input type="hidden" id="selectedMood" value="Verimli">
                <button class="btn-primary" id="saveBtn" onclick="saveData()">KAYDET âœ…</button>
            </div>
            <div id="panelPomodoro" class="hidden fade-in">
                <p style="text-align:center; color:var(--text-sub); font-size:0.9rem; margin-bottom:20px;">Odaklan ve sÃ¼reyi baÅŸlat.</p>
                <div id="chipsPomo" class="chips"></div>
                <input type="hidden" id="pomoSubject" value="">
                <div class="timer-setting">
                    <label style="font-weight:600; font-size:0.9rem;">SÃ¼re (dk):</label>
                    <input type="number" id="timerSetDuration" value="30" onchange="updateTimerDuration()">
                </div>
                <div class="timer-display" id="timerDisplay">30:00</div>
                <div class="timer-controls">
                    <button class="btn-start" onclick="startTimer()" id="btnTimerStart">BAÅLAT â–¶</button>
                    <button class="btn-stop" onclick="resetTimer()" id="btnTimerReset">SIFIRLA â†º</button>
                </div>
                <div class="question-inputs">
                    <div class="q-box"><label>Soru</label><input type="number" id="qCount" placeholder="0"></div>
                    <div class="q-box"><label>DoÄŸru</label><input type="number" id="qCorrect" placeholder="0"></div>
                </div>
                <button class="btn-primary" id="savePomoBtn" onclick="savePomodoroData()">KAYDET âœ…</button>
            </div>
        </div>
        <div class="card">
            <h4>SON KAYITLAR</h4>
            <ul id="historyList" class="history-list"><li style="text-align:center; color:var(--text-sub); padding:15px;">YÃ¼kleniyor...</li></ul>
        </div>
    </div>

    <div id="adminScreen" class="hidden fade-in">
        <div class="admin-header">
            <div>
                <h3 style="margin:0; font-size:1.5rem; letter-spacing: -0.5px;">YÃ¶netici Paneli ğŸ‘‘</h3>
                <small style="opacity:0.8;">TÃ¼m veriler analiz edildi ve birleÅŸtirildi.</small>
            </div>
            <button class="btn-logout-distinct" onclick="handleLogout()" style="background:rgba(255,255,255,0.15); color:white; border:none; backdrop-filter:blur(5px);">Ã‡Ä±kÄ±ÅŸ</button>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <span class="kpi-value" id="adminTotalStudents">0</span>
                <span class="kpi-label">Toplam Ã–ÄŸrenci</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-value" id="adminTotalHours">0</span>
                <span class="kpi-label">Toplam Saat</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-value" id="adminActiveToday" style="color:var(--success);">0</span>
                <span class="kpi-label">BugÃ¼n Aktif</span>
            </div>
        </div>

        <div class="card">
            <h4>ğŸš€ YÃœKSELEN YILDIZLAR</h4>
            <div class="rising-stars" id="risingStarsContainer">
                <div style="width:100%; text-align:center; color:var(--text-sub); font-size:0.9rem;">Analiz ediliyor...</div>
            </div>
        </div>

        <div class="card">
            <h4>ğŸ“ˆ GENEL PERFORMANS GRAFÄ°ÄÄ°</h4>
            <p style="font-size:0.8rem; color:var(--text-sub); margin-bottom:10px;">Tabloyu saÄŸa/sola kaydÄ±rarak tÃ¼m Ã¶ÄŸrencileri gÃ¶rebilirsiniz.</p>
            <div class="chart-scroll-container">
                <div class="chart-scroll-inner" id="chartInner">
                    <canvas id="adminLeaderboardChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h4>ğŸ‘¥ Ã–ÄRENCÄ° LÄ°STESÄ° & DEÄERLENDÄ°RME</h4>
            <div style="overflow-x:auto;">
                <table class="student-table" id="studentTable">
                    <thead><tr><th>SÄ±ra</th><th>Ã–ÄŸrenci</th><th>Durum</th><th>Toplam</th></tr></thead>
                    <tbody id="studentTableBody"><tr><td colspan="4" style="text-align:center;">Veriler birleÅŸtiriliyor...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div id="modalAdminDetail" class="modal hidden fade-in">
    <div class="modal-content" style="max-width:500px;">
        <div style="text-align:right;">
            <button onclick="closeAdminDetail()" style="width:32px; height:32px; padding:0; border-radius:50%; background:#f1f5f9; border:none; cursor:pointer;">âœ•</button>
        </div>
        
        <div class="guidance-header">
            <h2 id="detailStudentName" style="color:var(--text-main); margin-bottom:5px;">Ã–ÄŸrenci AdÄ±</h2>
            <div id="smartEvaluationBadge" style="display:inline-block; padding:5px 15px; background:#e0e7ff; border-radius:20px; font-weight:700; color:var(--primary); font-size:0.9rem;">Analiz Ediliyor...</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
            <div style="background:#fff; border:1px solid #f1f5f9; padding:15px; border-radius:16px; text-align:center;">
                <div class="guidance-score" id="statTotalMin">0</div>
                <div class="guidance-label">Toplam Dakika</div>
            </div>
            <div style="background:#fff; border:1px solid #f1f5f9; padding:15px; border-radius:16px; text-align:center;">
                <div class="guidance-score" id="statAvg">0</div>
                <div class="guidance-label">GÃ¼nlÃ¼k Ort.</div>
            </div>
        </div>

        <h4>ğŸ§  AKILLI DEÄERLENDÄ°RME</h4>
        <div class="ai-comment" id="aiComment">
            Ã–ÄŸrenci verileri inceleniyor...
        </div>

        <div style="height: 200px; width: 100%; margin-bottom: 20px;">
            <canvas id="studentDetailChart"></canvas>
        </div>
        
        <button class="btn-primary" onclick="closeAdminDetail()">KAPAT</button>
    </div>
</div>

<div id="modalSubjects" class="modal hidden fade-in">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Dersleri DÃ¼zenle</h3>
            <button onclick="closeSubjectModal()" style="width:32px; height:32px; padding:0; border-radius:50%; background:#f1f5f9; color:#333;">âœ•</button>
        </div>
        <div id="subjectListContainer"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <input type="text" id="newSubjectName" placeholder="Yeni Ders Ekle" style="margin:0;">
            <button onclick="addSubject()" style="width:60px; background:var(--success); color:white; padding:0; border-radius:12px;">+</button>
        </div>
    </div>
</div>
<div id="modalEditEntry" class="modal hidden fade-in">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">KaydÄ± DÃ¼zenle</h3>
            <button onclick="closeEditModal()" style="width:32px; height:32px; padding:0; border-radius:50%; background:#f1f5f9; color:#333;">âœ•</button>
        </div>
        <input type="hidden" id="editEntryId"><input type="hidden" id="editOldDuration"> 
        <label style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px; display:block;">Ders</label>
        <select id="editSubject" style="margin-bottom:15px; padding:12px; border-radius:12px; border:2px solid #e5e7eb;"></select>
        <label style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px; display:block;">SÃ¼re (dk)</label>
        <input type="number" id="editDuration" style="margin-bottom:15px;">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div style="flex:1;"><label style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px; display:block;">Soru</label><input type="number" id="editQCount"></div>
            <div style="flex:1;"><label style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px; display:block;">DoÄŸru</label><input type="number" id="editQCorrect"></div>
        </div>
        <label style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px; display:block;">Verim</label>
        <select id="editMood" style="margin-bottom:20px; padding:12px; border-radius:12px; border:2px solid #e5e7eb;">
            <option value="Verimli">ğŸ”¥ Verimli (SÃ¼per)</option>
            <option value="Orta">ğŸ˜ Orta (Normal)</option>
            <option value="Verimsiz">ğŸ˜´ Verimsiz (Az)</option>
        </select>
        <button class="btn-primary" onclick="saveEditedEntry()">DEÄÄ°ÅÄ°KLÄ°KLERÄ° KAYDET</button>
    </div>
</div>
<div id="modalProfile" class="modal hidden fade-in">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Profil AyarlarÄ±</h3>
            <button onclick="closeProfileModal()" style="width:32px; height:32px; padding:0; border-radius:50%; background:#f1f5f9; color:#333;">âœ•</button>
        </div>
        <label style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px; display:block;">Ã–ÄŸrenci AdÄ± SoyadÄ±</label>
        <input type="text" id="editProfileName" style="margin-bottom:15px;">
        <label style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px; display:block;">E-Posta (DeÄŸiÅŸtirilemez)</label>
        <input type="text" id="editProfileEmail" disabled style="opacity:0.6; margin-bottom:20px;">
        <button class="btn-primary" onclick="saveUserProfile()">KAYDET</button>
        <div style="margin-top:20px; text-align:center;"><button onclick="sendPasswordReset()" style="background:none; border:none; color:var(--primary); text-decoration:underline; font-size:0.85rem; padding:5px;">Åifremi Unuttum / SÄ±fÄ±rla</button></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, addDoc, deleteDoc, getDocs, query, where, onSnapshot, serverTimestamp, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBkJg6hiMPcgM-bywHjUCKdD8CapA1VDHk", authDomain: "ogrencitakip-bcdbd.firebaseapp.com", projectId: "ogrencitakip-bcdbd", storageBucket: "ogrencitakip-bcdbd.firebasestorage.app", messagingSenderId: "74510222174", appId: "1:74510222174:web:9d379386762064ee0f45cf" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_EMAIL = "mremzi@gmail.com";

    let currentUser = null;
    let isLoginMode = true;
    let myChart = null, adminChart = null, detailChart = null;
    let currentWeeklyTotal = 0;
    let mySubjects = [];
    let timerInterval = null, timeLeft = 30 * 60, isTimerRunning = false;

    // --- AUTH ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('authScreen').classList.add('hidden');
            if(user.email === ADMIN_EMAIL) {
                document.getElementById('adminScreen').classList.remove('hidden');
                document.getElementById('mainContainer').classList.add('admin-mode');
                loadAdminDashboard();
            } else {
                document.getElementById('dashboardScreen').classList.remove('hidden');
                const name = user.displayName || "Ã–ÄŸrenci";
                document.getElementById('studentNameDisplay').innerText = name.split(' ')[0];
                await loadUserProfile(user.uid);
                if(!myChart) initChart();
                listenToData();
            }
        } else {
            currentUser = null;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('admin-mode');
        }
    });

    // --- SMART ADMIN DASHBOARD ---
    async function loadAdminDashboard() {
        const usersRef = collection(db, "users");
        onSnapshot(usersRef, (snapshot) => {
            // 1. DATA MERGING LOGIC
            const mergedUsers = {}; 
            
            snapshot.forEach(doc => {
                const data = doc.data();
                if(data.email === ADMIN_EMAIL) return; // Admini katma

                // Benzersiz Anahtar: Ä°sim Soyisim (BoÅŸluklar atÄ±lÄ±p kÃ¼Ã§Ã¼k harf yapÄ±larak)
                // E-posta ile de birleÅŸtirebilirdik ama Firebase Auth zaten e-postayÄ± tekil tutar.
                // Burada aynÄ± isimle farklÄ± maillerle girenleri birleÅŸtiriyoruz.
                const key = (data.displayName || data.email).toLowerCase().trim();

                if (!mergedUsers[key]) {
                    mergedUsers[key] = {
                        displayId: doc.id, // Detay iÃ§in herhangi bir ID yeterli (sorguda kullanÄ±lacak)
                        name: data.displayName || data.email,
                        totalMinutes: 0,
                        lastStudyDate: null,
                        originalDocs: [] // Ä°lerde gerekirse tÃ¼m ID'ler burada
                    };
                }
                
                mergedUsers[key].totalMinutes += (data.totalMinutes || 0);
                mergedUsers[key].originalDocs.push(doc.id);
                
                // En son Ã§alÄ±ÅŸma tarihini bul
                const docDate = data.lastStudyDate ? (data.lastStudyDate.toDate ? data.lastStudyDate.toDate() : new Date(data.lastStudyDate)) : null;
                if (docDate) {
                    if (!mergedUsers[key].lastStudyDate || docDate > mergedUsers[key].lastStudyDate) {
                        mergedUsers[key].lastStudyDate = docDate;
                    }
                }
            });

            // 2. ARRAY CONVERSION & SORTING
            const userList = Object.values(mergedUsers).sort((a, b) => b.totalMinutes - a.totalMinutes);
            
            // 3. UPDATE UI
            document.getElementById('adminTotalStudents').innerText = userList.length;
            
            let totalSystemMins = 0;
            let activeTodayCount = 0;
            const today = new Date().toDateString();

            userList.forEach(u => {
                totalSystemMins += u.totalMinutes;
                if(u.lastStudyDate && u.lastStudyDate.toDateString() === today) activeTodayCount++;
            });

            document.getElementById('adminTotalHours').innerText = Math.floor(totalSystemMins / 60);
            document.getElementById('adminActiveToday').innerText = activeTodayCount;

            renderAdminTable(userList);
            renderAdminChart(userList);
            renderRisingStars(userList);
        });
    }

    // YÃ¼kselen YÄ±ldÄ±zlar (Son 24 saatte aktif olanlar arasÄ±ndan en Ã§ok Ã§alÄ±ÅŸanlar)
    function renderRisingStars(users) {
        const container = document.getElementById('risingStarsContainer');
        container.innerHTML = "";
        
        // Basit mantÄ±k: Son Ã§alÄ±ÅŸma tarihi "bugÃ¼n" veya "dÃ¼n" olanlarÄ± al
        const now = new Date();
        const oneDay = 24 * 60 * 60 * 1000;
        
        const stars = users.filter(u => {
            if(!u.lastStudyDate) return false;
            return (now - u.lastStudyDate) < (oneDay * 2); // Son 2 gÃ¼n
        }).sort((a,b) => b.totalMinutes - a.totalMinutes).slice(0, 5); // Ä°lk 5

        if (stars.length === 0) {
            container.innerHTML = "<div style='width:100%; text-align:center; padding:10px; color:#94a3b8;'>HenÃ¼z yÃ¼kselen yÄ±ldÄ±z yok.</div>";
            return;
        }

        stars.forEach(u => {
            const card = document.createElement('div');
            card.className = "star-card";
            card.innerHTML = `
                <span class="star-icon">ğŸš€</span>
                <div style="font-weight:700; font-size:0.9rem; color:var(--text-main);">${u.name.split(' ')[0]}</div>
                <div style="font-size:0.8rem; color:var(--success); font-weight:600;">Aktif</div>
            `;
            container.appendChild(card);
        });
    }

    function renderAdminTable(users) {
        const tbody = document.getElementById('studentTableBody'); 
        tbody.innerHTML = "";
        
        users.forEach((u, index) => {
            const tr = document.createElement('tr'); 
            
            // Smart Evaluation Logic
            const evaluation = evaluateStudent(u.totalMinutes, u.lastStudyDate);
            
            tr.onclick = () => openAdminDetail(u.displayId, u.name, evaluation, u);
            
            tr.innerHTML = `
                <td style="font-weight:700; color:#94a3b8;">#${index+1}</td>
                <td>
                    <div style="font-weight:600; color:var(--text-main); font-size:1rem;">${u.name}</div>
                    <div style="font-size:0.75rem; color:var(--text-sub);">${u.lastStudyDate ? u.lastStudyDate.toLocaleDateString('tr-TR') : 'GiriÅŸ Yok'}</div>
                </td>
                <td>
                    <span class="smart-badge ${evaluation.badgeClass}">
                        ${evaluation.icon} ${evaluation.text}
                    </span>
                </td>
                <td style="font-weight:800; color:var(--primary); font-size:1rem;">
                    ${Math.floor(u.totalMinutes / 60)}s ${(u.totalMinutes % 60)}dk
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function evaluateStudent(minutes, lastDate) {
        if (!lastDate) return { text: "Veri Yok", badgeClass: "sb-idle", icon: "âšª", comment: "Ã–ÄŸrenci henÃ¼z sisteme veri giriÅŸi yapmamÄ±ÅŸ." };
        
        const now = new Date();
        const daysDiff = (now - lastDate) / (1000 * 60 * 60 * 24);
        
        if (daysDiff > 7) return { text: "Riskli", badgeClass: "sb-risk", icon: "âš ï¸", comment: "Ã–ÄŸrenci 1 haftadan fazladÄ±r Ã§alÄ±ÅŸma girmiyor. Ä°letiÅŸime geÃ§ilmeli." };
        if (daysDiff > 3) return { text: "Kopuk", badgeClass: "sb-idle", icon: "ğŸ’¤", comment: "Ã‡alÄ±ÅŸma sÃ¼rekliliÄŸi dÃ¼ÅŸÃ¼k. Motivasyon desteÄŸi gerekebilir." };
        
        if (minutes > 3000) return { text: "YÄ±ldÄ±z", badgeClass: "sb-star", icon: "ğŸŒŸ", comment: "Muazzam performans! SÄ±nÄ±fÄ±n liderlerinden." };
        if (minutes > 1000) return { text: "Ä°yi", badgeClass: "sb-good", icon: "ğŸ‘", comment: "Ä°stikrarlÄ± ve dÃ¼zenli Ã§alÄ±ÅŸÄ±yor. BaÅŸarÄ±lÄ±." };
        
        return { text: "BaÅŸlangÄ±Ã§", badgeClass: "sb-good", icon: "ğŸŒ±", comment: "Ã‡alÄ±ÅŸmaya yeni baÅŸlamÄ±ÅŸ veya sÃ¼resi henÃ¼z dÃ¼ÅŸÃ¼k." };
    }

    function renderAdminChart(users) {
        // Dinamik geniÅŸlik ayarÄ±
        const container = document.getElementById('chartInner');
        const minWidth = Math.max(users.length * 60, 400); // Ã–ÄŸrenci baÅŸÄ±na 60px veya min 400px
        container.style.width = minWidth + "px";

        const ctx = document.getElementById('adminLeaderboardChart').getContext('2d');
        const labels = users.map(u => u.name.split(' ')[0]); // Sadece ilk isimler
        const data = users.map(u => u.totalMinutes);
        
        if(adminChart) adminChart.destroy();
        
        adminChart = new Chart(ctx, { 
            type: 'bar', 
            data: { 
                labels: labels, 
                datasets: [{ 
                    label: 'Toplam Dakika', 
                    data: data, 
                    backgroundColor: '#6366f1',
                    borderRadius: 8,
                    barThickness: 40 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { beginAtZero: true, grid: { display: false } }, 
                    x: { grid: { display: false } } 
                } 
            } 
        });
    }

    // --- REHBERLÄ°K DETAYI ---
    window.openAdminDetail = async (uid, name, evaluation, userObj) => {
        document.getElementById('detailStudentName').innerText = name;
        document.getElementById('smartEvaluationBadge').innerText = evaluation.icon + " " + evaluation.text;
        document.getElementById('smartEvaluationBadge').className = `smart-badge ${evaluation.badgeClass}`;
        document.getElementById('smartEvaluationBadge').style.fontSize = "1.2rem";
        
        document.getElementById('aiComment').innerText = evaluation.comment;
        document.getElementById('modalAdminDetail').classList.remove('hidden');

        // Ä°statistikler (UserObj iÃ§inden direkt alÄ±yoruz)
        document.getElementById('statTotalMin').innerText = userObj.totalMinutes;
        
        // Grafik Verisini Ã‡ek (Sadece UID'ye ait sessions)
        const dates = [];
        for (let i = 0; i < 7; i++) { const d = new Date(); d.setDate(d.getDate() - i); dates.push(d.toLocaleDateString('tr-TR')); }
        dates.reverse();

        const snapshot = await getDocs(query(collection(db, "users", uid, "sessions")));
        const statsByDate = {};
        dates.forEach(d => statsByDate[d] = 0);
        
        let totalWeek = 0;
        snapshot.forEach(doc => {
            const s = doc.data();
            if (statsByDate.hasOwnProperty(s.dateStr)) {
                statsByDate[s.dateStr] += s.duration;
                totalWeek += s.duration;
            }
        });

        document.getElementById('statAvg').innerText = Math.round(totalWeek / 7);

        // Ã‡izgi Grafik
        const ctx = document.getElementById('studentDetailChart').getContext('2d');
        if (detailChart) detailChart.destroy(); 
        detailChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Dakika',
                    data: dates.map(d => statsByDate[d]),
                    borderColor: '#ec4899',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    };
    
    window.closeAdminDetail = () => { document.getElementById('modalAdminDetail').classList.add('hidden'); };

    // --- STANDARD USER FUNCTIONS (Ã–nceki kodlarÄ±n aynÄ±sÄ±) ---
    async function loadUserProfile(uid) {
        const userDocRef = doc(db, "users", uid);
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            mySubjects = data.subjects || ['Matematik', 'TÃ¼rkÃ§e', 'Fen', 'Ä°ngilizce', 'Genel', 'Kitap'];
            document.getElementById('weeklyGoalInput').value = data.weeklyGoal || 1000;
        } else {
            mySubjects = ['Matematik', 'TÃ¼rkÃ§e', 'Fen', 'Ä°ngilizce', 'Genel', 'Kitap'];
            await setDoc(userDocRef, { email: currentUser.email, displayName: currentUser.displayName, subjects: mySubjects, weeklyGoal: 1000, totalMinutes: 0, createdAt: serverTimestamp() });
        }
        renderAllChips();
    }
    
    // ... (DiÄŸer fonksiyonlar: listenToData, deleteEntry, openEditModal vb. aynÄ± kalÄ±yor) ...
    // Kod tekrarÄ±nÄ± Ã¶nlemek iÃ§in standart fonksiyonlarÄ± aÅŸaÄŸÄ±ya sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ olarak ekliyorum.
    
    window.openProfileModal=()=>{document.getElementById('editProfileName').value=currentUser.displayName||"";document.getElementById('editProfileEmail').value=currentUser.email||"";document.getElementById('modalProfile').classList.remove('hidden')};window.closeProfileModal=()=>document.getElementById('modalProfile').classList.add('hidden');window.saveUserProfile=async()=>{const n=document.getElementById('editProfileName').value.trim();if(!n){alert("Ä°sim boÅŸ olamaz.");return}try{await updateProfile(currentUser,{displayName:n});await updateDoc(doc(db,"users",currentUser.uid),{displayName:n});document.getElementById('studentNameDisplay').innerText=n.split(' ')[0];alert("Profil gÃ¼ncellendi âœ…");closeProfileModal()}catch(e){alert("Hata: "+e.message)}};window.sendPasswordReset=async()=>{if(confirm(currentUser.email+" adresine ÅŸifre sÄ±fÄ±rlama e-postasÄ± gÃ¶nderilsin mi?")){try{await sendPasswordResetEmail(auth,currentUser.email);alert("E-posta gÃ¶nderildi!")}catch(e){alert("Hata: "+e.message)}}};
    function listenToData(){if(!currentUser)return;const q=query(collection(db,"users",currentUser.uid,"sessions"));onSnapshot(q,(s)=>{const l=document.getElementById('historyList');l.innerHTML="";let wt=0;const now=new Date();const wa=new Date();wa.setDate(now.getDate()-7);const i=[];s.forEach(d=>i.push({id:d.id,...d.data()}));i.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));i.forEach((d,idx)=>{if(idx<10){const li=document.createElement('li');li.className='history-item fade-in';const ds=JSON.stringify(d).replace(/"/g,'&quot;');li.innerHTML=`<div style="flex:1;"><div style="font-weight:600;color:var(--text-main);">${d.subject}</div><div style="font-size:0.8rem;color:var(--text-sub);margin-top:2px;">â±ï¸ ${d.duration} dk <span style="margin-left:5px;opacity:0.6;">â€¢ ${d.dateStr}</span></div></div><div style="display:flex;align-items:center;"><button class="btn-action btn-edit" onclick="openEditModal(${ds})">âœï¸</button><button class="btn-action btn-delete" onclick="deleteEntry('${d.id}',${d.duration})">ğŸ—‘ï¸</button></div>`;l.appendChild(li)}let is=(d.createdAt?.seconds)||0;let id=new Date(is*1000);if(id>=wa)wt+=d.duration});if(i.length===0)l.innerHTML="<li style='padding:20px;text-align:center;color:var(--text-sub);'>HenÃ¼z kayÄ±t yok.</li>";currentWeeklyTotal=wt;updateChartDisplay(wt);calculateStreak(i)})};
    window.deleteEntry=async(id,dur)=>{if(!confirm("Silinsin mi?"))return;try{await deleteDoc(doc(db,"users",currentUser.uid,"sessions",id));await updateDoc(doc(db,"users",currentUser.uid),{totalMinutes:increment(-dur)})}catch(e){alert(e.message)}};
    window.openEditModal=(d)=>{const s=document.getElementById('editSubject');s.innerHTML="";mySubjects.forEach(x=>{const o=document.createElement('option');o.value=x;o.innerText=x;if(x===d.subject)o.selected=true;s.appendChild(o)});document.getElementById('editEntryId').value=d.id;document.getElementById('editOldDuration').value=d.duration;document.getElementById('editDuration').value=d.duration;document.getElementById('editMood').value=d.mood;document.getElementById('modalEditEntry').classList.remove('hidden')};window.closeEditModal=()=>document.getElementById('modalEditEntry').classList.add('hidden');window.saveEditedEntry=async()=>{const id=document.getElementById('editEntryId').value;const od=parseInt(document.getElementById('editOldDuration').value);const nd=parseInt(document.getElementById('editDuration').value);const mood=document.getElementById('editMood').value;const sub=document.getElementById('editSubject').value;try{await updateDoc(doc(db,"users",currentUser.uid,"sessions",id),{subject:sub,duration:nd,mood:mood});const diff=nd-od;if(diff!==0)await updateDoc(doc(db,"users",currentUser.uid),{totalMinutes:increment(diff)});closeEditModal()}catch(e){alert(e.message)}};
    window.renderAllChips=()=>{renderChips('chipsManual','selectedSubject');renderChips('chipsPomo','pomoSubject')};window.renderChips=(cId,iId)=>{const c=document.getElementById(cId);c.innerHTML="";let cv=document.getElementById(iId).value;if(!mySubjects.includes(cv)&&mySubjects.length>0){cv=mySubjects[0];document.getElementById(iId).value=cv}mySubjects.forEach(s=>{const d=document.createElement('div');d.className='chip';d.innerText=s;if(s===cv)d.classList.add('active');d.onclick=function(){c.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));this.classList.add('active');document.getElementById(iId).value=s};c.appendChild(d)});const e=document.createElement('div');e.className='chip chip-edit';e.innerText="âœï¸";e.onclick=openSubjectModal;c.appendChild(e)};
    window.openSubjectModal=()=>{const l=document.getElementById('subjectListContainer');l.innerHTML="";mySubjects.forEach(s=>{const i=document.createElement('div');i.innerHTML=`<span>${s}</span> <button onclick="removeSubject('${s}')">ğŸ—‘ï¸</button>`;i.style.cssText="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;";l.appendChild(i)});document.getElementById('modalSubjects').classList.remove('hidden')};window.closeSubjectModal=()=>document.getElementById('modalSubjects').classList.add('hidden');window.addSubject=async()=>{const n=document.getElementById('newSubjectName').value.trim();if(n&&currentUser){await updateDoc(doc(db,"users",currentUser.uid),{subjects:arrayUnion(n)});mySubjects.push(n);document.getElementById('newSubjectName').value="";openSubjectModal();renderAllChips()}};window.removeSubject=async(n)=>{if(confirm("Silinsin mi?")&&currentUser){await updateDoc(doc(db,"users",currentUser.uid),{subjects:arrayRemove(n)});mySubjects=mySubjects.filter(s=>s!==n);openSubjectModal();renderAllChips()}};
    window.updateGoal=async()=>{const v=parseInt(document.getElementById('weeklyGoalInput').value);if(currentUser&&v){await updateDoc(doc(db,"users",currentUser.uid),{weeklyGoal:v});updateChartDisplay(currentWeeklyTotal)}};function initChart(){const c=document.getElementById('weeklyChart').getContext('2d');myChart=new Chart(c,{type:'doughnut',data:{labels:['Tamamlanan','Kalan'],datasets:[{data:[0,100],backgroundColor:['#6366f1','#e2e8f0'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'80%',plugins:{legend:{display:false}}}})}function calculateStreak(i){const u=[...new Set(i.map(x=>x.dateStr))];document.getElementById('streakCount').innerText=u.length>0?u.length:0;}function updateChartDisplay(t){if(!myChart)return;const g=parseInt(document.getElementById('weeklyGoalInput').value)||1000;document.getElementById('completedMins').innerText=t;document.getElementById('targetMins').innerText=g;let r=g-t;if(r<0)r=0;myChart.data.datasets[0].data=[t,r];myChart.update()}
    window.handleLogin=async()=>{const e=document.getElementById('email').value,p=document.getElementById('password').value,n=document.getElementById('regStudentName').value;try{if(isLoginMode)await signInWithEmailAndPassword(auth,e,p);else{const c=await createUserWithEmailAndPassword(auth,e,p);await updateProfile(c.user,{displayName:n})}}catch(err){document.getElementById('authError').style.display='block';document.getElementById('authError').innerText=err.message}};window.toggleAuthMode=()=>{isLoginMode=!isLoginMode;document.getElementById('authTitle').innerText=isLoginMode?"GiriÅŸ Yap":"KayÄ±t Ol";document.getElementById('mainAuthBtn').innerText=isLoginMode?"GÄ°RÄ°Å YAP":"KAYIT OL";document.getElementById('regStudentName').classList.toggle('hidden');document.getElementById('toggleText').innerHTML=isLoginMode?"HesabÄ±nÄ±z yok mu? <b>KayÄ±t Olun</b>":"HesabÄ±nÄ±z var mÄ±? <b>GiriÅŸ YapÄ±n</b>"};window.handleLogout=()=>signOut(auth);
    window.selectMood=(e,v)=>{document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('selected'));e.classList.add('selected');document.getElementById('selectedMood').value=v};window.adjustTime=(v)=>{const e=document.getElementById('duration');e.value=Math.max(0,(parseInt(e.value)||0)+v)};window.switchTab=(t)=>{if(t==='manual'){document.getElementById('panelManual').classList.remove('hidden');document.getElementById('panelPomodoro').classList.add('hidden');document.getElementById('tabManual').classList.add('active');document.getElementById('tabPomodoro').classList.remove('active')}else{document.getElementById('panelManual').classList.add('hidden');document.getElementById('panelPomodoro').classList.remove('hidden');document.getElementById('tabManual').classList.remove('active');document.getElementById('tabPomodoro').classList.add('active')}};window.updateTimerDuration=()=>{if(!isTimerRunning){timeLeft=(parseInt(document.getElementById('timerSetDuration').value)||30)*60;updateTimerDisplay()}};window.startTimer=()=>{if(isTimerRunning)return;isTimerRunning=true;document.getElementById('btnTimerStart').innerText="â³";timerInterval=setInterval(()=>{timeLeft--;updateTimerDisplay();if(timeLeft<=0){clearInterval(timerInterval);finishPomodoro()}},1000)};window.resetTimer=()=>{clearInterval(timerInterval);isTimerRunning=false;timeLeft=(parseInt(document.getElementById('timerSetDuration').value)||30)*60;updateTimerDisplay();document.getElementById('btnTimerStart').innerText="BAÅLAT â–¶"};function updateTimerDisplay(){const m=Math.floor(timeLeft/60),s=timeLeft%60;document.getElementById('timerDisplay').innerText=`${m}:${s.toString().padStart(2,'0')}`}function finishPomodoro(){const a=new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');a.play().catch(e=>{});savePomodoroData();alert("SÃ¼re Doldu!");resetTimer()}
    window.savePomodoroData=()=>{if(isTimerRunning){if(!confirm("Kaydedilsin mi?"))return;resetTimer()}const s=document.getElementById('pomoSubject').value,d=parseInt(document.getElementById('timerSetDuration').value)||30;saveToFirebase(s,d,0,0,'Verimli','savePomoBtn')};
    window.saveData=()=>{const s=document.getElementById('selectedSubject').value,d=parseInt(document.getElementById('duration').value),m=document.getElementById('selectedMood').value,o=parseInt(document.getElementById('entryDateSelect').value)||0,dt=new Date();dt.setDate(dt.getDate()-o);saveToFirebase(s,d,0,0,m,'saveBtn',dt.toLocaleDateString('tr-TR'))};
    async function saveToFirebase(s,d,q,c,m,bId,dateS=null){if(!currentUser)return;const btn=document.getElementById(bId);btn.disabled=true;const fDate=dateS||new Date().toLocaleDateString('tr-TR');try{await addDoc(collection(db,"users",currentUser.uid,"sessions"),{subject:s,duration:d,questionCount:q,correctCount:c,mood:m,dateStr:fDate,createdAt:serverTimestamp()});await updateDoc(doc(db,"users",currentUser.uid),{totalMinutes:increment(d),lastStudyDate:serverTimestamp()});btn.disabled=false;if(bId!=='savePomoBtn')document.getElementById('entryDateSelect').value="0"}catch(e){alert("Hata: "+e.message);btn.disabled=false}}

    // Export Window Functions
    window.removeSubject=window.removeSubject;window.addSubject=window.addSubject;window.openSubjectModal=window.openSubjectModal;window.closeSubjectModal=window.closeSubjectModal;window.savePomodoroData=window.savePomodoroData;window.openAdminDetail=window.openAdminDetail;window.closeAdminDetail=window.closeAdminDetail;window.openProfileModal=window.openProfileModal;window.closeProfileModal=window.closeProfileModal;window.saveUserProfile=window.saveUserProfile;window.sendPasswordReset=window.sendPasswordReset;window.saveEditedEntry=window.saveEditedEntry;window.openEditModal=window.openEditModal;window.closeEditModal=window.closeEditModal;window.deleteEntry=window.deleteEntry;
</script>
</body>
</html>