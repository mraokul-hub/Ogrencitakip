<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bilge Takip - YÃ¶netici Paneli</title>
    
    <link rel="icon" href="Designer.jpg" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        .hidden { display: none !important; visibility: hidden !important; opacity: 0 !important; }
        :root { --primary: #009688; --text-main: #0f172a; --text-sub: #475569; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text !important; }
        body { font-family: 'Outfit', sans-serif; background: #f1f5f9; margin: 0; padding: 15px; min-height: 100vh; color: var(--text-main); }
        .container.admin-mode { max-width: 1000px; margin: 0 auto; }
        .card { background: #ffffff; border-radius: 24px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); padding: 24px; margin-bottom: 24px; border: 1px solid #e2e8f0; }
        
        .admin-header { background: linear-gradient(135deg, #004d40, #00695c); padding: 20px 30px; border-radius: 24px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 15px 30px rgba(0, 77, 64, 0.3); color:white; }
        .tabs-admin { display: flex; gap: 15px; margin-bottom: 30px; background: rgba(255,255,255,0.6); padding: 10px; border-radius: 20px; overflow-x: auto;}
        .tab-admin { padding: 12px 24px; border-radius: 15px; font-weight: 700; color: var(--text-sub); cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .tab-admin.active { background: white; color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 25px; border-radius: 24px; text-align: center; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid #f1f9f9; }
        .kpi-value { font-size: 2.5rem; font-weight: 800; color: var(--primary); display: block; }
        .kpi-label { font-size: 0.75rem; font-weight: 800; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
        
        .student-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .student-table th { text-align: left; padding: 15px; color: var(--text-sub); font-size: 0.75rem; text-transform: uppercase; font-weight: 800; }
        .student-table td { padding: 15px; background: white; font-size: 0.95rem; vertical-align: middle; border-top:1px solid #f8fafc; border-bottom:1px solid #f8fafc; }
        .student-table tr:hover { transform: scale(1.01); cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.2s; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .status-lider { background: #fffbeb; color: #d97706; border: 1px solid #fcd34d; }
        .status-iyi { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .status-riskli { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
        
        .btn-action { width: 100%; padding: 15px; border-radius: 16px; font-size: 1rem; font-weight: 800; color: white; background: var(--primary); border:none; cursor:pointer; }
        .btn-smart { padding:8px 15px; border-radius:12px; font-weight:700; font-size:0.8rem; cursor: pointer; border:none; margin:5px; }
        .btn-lib { background:#f8fafc; border:1px solid #e2e8f0; padding:12px; border-radius:12px; text-align:left; font-size:0.8rem; color:#475569; transition:0.2s; font-weight:600; cursor: pointer; width: 100%; margin-bottom: 5px;}
        .btn-lib:hover { background: #e2e8f0; }
        .input-modern { background: #f1f5f9; border: none; border-radius: 12px; padding: 12px; width: 100%; outline: none; margin-bottom:10px; font-family: inherit;}
        
        .rising-stars { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .star-card { background: white; padding: 15px; border-radius: 20px; text-align: center; border: 2px solid #f0fdf4; cursor: pointer; transition: 0.2s; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 77, 64, 0.6); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 30px; width: 100%; max-width: 800px; max-height: 85vh; overflow-y: auto; }
        
        /* SWAL2 Z-INDEX AYARI */
        .swal2-container { z-index: 10000 !important; }
        
        .selector-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .selector-item:hover { background: #f8fafc; }
        .chk-student { transform: scale(1.3); margin-right: 15px; accent-color: var(--primary); }
        
        .msg-pool-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 15px; background: #fafafa; }
        .msg-pool-item { background: white; padding: 10px; border-radius: 10px; border: 1px solid #eee; font-size: 0.8rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .msg-pool-item:hover { border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-type-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 6px; font-weight: 800; text-transform: uppercase; color: white; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="container admin-mode" id="mainContainer">
    <div id="authScreen" style="text-align:center; padding-top:100px;">
        <h2>YÃ¶netici GiriÅŸi ğŸ›¡ï¸</h2>
        <div class="card" style="max-width:400px; margin:20px auto;">
            <input type="email" id="email" placeholder="E-Posta" class="input-modern" value="mremzi@gmail.com">
            <input type="password" id="password" placeholder="Åifre" class="input-modern">
            <button class="btn-action" onclick="handleLogin()">GÄ°RÄ°Å YAP</button>
            <div id="authError" style="color:red; margin-top:10px; display:none; font-weight:bold;"></div>
            <div id="authLog" style="color:#666; font-size:0.75rem; margin-top:10px; display:none;">BaÄŸlanÄ±yor...</div>
        </div>
    </div>

    <div id="adminScreen" class="hidden">
        <div class="admin-header">
            <div><h3 style="margin:0; font-size:1.8rem; color:white; font-weight:800;">YÃ¶netici Paneli ğŸ‘‘</h3><p style="color:rgba(255,255,255,0.8); margin:5px 0 0 0; font-size:0.9rem;">Veriler birleÅŸtirildi ve analiz edildi.</p></div>
            <button onclick="handleLogout()" style="background:rgba(255,255,255,0.2); color:white; padding:10px 20px; border-radius:15px; font-weight:700; backdrop-filter:blur(5px); border:none; cursor:pointer;">Ã‡Ä±kÄ±ÅŸ</button>
        </div>

        <div class="tabs-admin">
            <div class="tab-admin active" onclick="switchAdminTab('dashboard', this)">ğŸ“Š Genel Durum</div>
            <div class="tab-admin" onclick="switchAdminTab('messages', this)">âœ‰ï¸ Mesaj Merkezi</div>
            <div class="tab-admin" onclick="switchAdminTab('history', this)">ğŸ“œ GÃ¶nderilenler</div>
            <div class="tab-admin" onclick="switchAdminTab('clan', this)">â›º OtaÄŸ YÃ¶netimi</div>
            <div class="tab-admin" onclick="switchAdminTab('owl', this)">ğŸ¦‰ Bilgelik YÃ¶netimi</div>
            <div class="tab-admin" onclick="switchAdminTab('capsules', this)">â³ KapsÃ¼ller</div>
        </div>
        
        <div id="adminPanelDashboard">
            <div class="card" style="background:#ecfdf5; border:2px solid #10b981; display:flex; align-items:center; gap:20px;">
                <div style="font-size:3rem;">ğŸ¦‰</div>
                <div>
                    <h3 style="color:#065f46; margin-bottom:5px;">HakanÄ±m, Raporum HazÄ±r!</h3>
                    <p id="adminReportText" style="color:#047857; font-size:0.95rem; margin:0;">Veriler inceleniyor...</p>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="btn-smart" style="background:#fee2e2; color:#b91c1c;" onclick="analyzeAndWarn()">âš ï¸ Geride KalanlarÄ± Uyar</button>
                        <button class="btn-smart" style="background:#d1fae5; color:#065f46;" onclick="analyzeAndCongratulate()">ğŸŒŸ YÄ±ldÄ±zlarÄ± Kutla</button>
                    </div>
                </div>
            </div>

            <div class="card" style="background:#fff7ed; border:2px solid #f97316;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="color:#c2410c; margin:0;">ğŸ”§ SÄ°STEM BAKIMI VE ONARIM</h4><span style="font-size:1.5rem;">âš–ï¸</span>
                </div>
                <p style="font-size:0.9rem; color:#9a3412; margin:10px 0;">HakanÄ±m, bu iÅŸlem tÃ¼m Ã¶ÄŸrencilerin geÃ§miÅŸ Ã§alÄ±ÅŸma kayÄ±tlarÄ±nÄ± tarar. PuanlarÄ± <strong>yeni sisteme (Normal x1, SayaÃ§ x1.5, Arena x2 + OtaÄŸ Bonusu)</strong> gÃ¶re yeniden hesaplar.</p>
                <button class="btn-action" onclick="recalculateAllScores()" style="background:#ea580c; width:auto; padding:10px 20px;">TÃœM PUANLARI YENÄ°DEN HESAPLA â†»</button>
                <div id="repairStatus" style="margin-top:10px; font-weight:bold; color:#c2410c; display:none;">Ä°ÅŸleniyor...</div>
            </div>
            
            <div class="kpi-grid">
                <div class="kpi-card"><span class="kpi-value" id="adminTotalStudents">0</span><span class="kpi-label">TOPLAM Ã–ÄRENCÄ°</span></div>
                <div class="kpi-card"><span class="kpi-value" id="adminTotalHours">0</span><span class="kpi-label">TOPLAM SAAT</span></div>
                <div class="kpi-card"><span class="kpi-value" id="adminActiveToday">0</span><span class="kpi-label">BUGÃœN AKTÄ°F</span></div>
            </div>

            <div class="card"><h4>ğŸš€ YÃœKSELEN YILDIZLAR</h4><div class="rising-stars" id="risingStarsContainer"><div style="text-align:center; color:#aaa; width:100%;">Analiz ediliyor...</div></div></div>
            <div class="card"><h4>ğŸ“ˆ GENEL PERFORMANS (3D)</h4><div style="height:400px;" id="adminLeaderboardChart"></div></div>
            
            <div class="card">
                <h4>ğŸ‘¥ Ã–ÄRENCÄ° LÄ°STESÄ°</h4>
                <div style="overflow-x:auto;">
                    <table class="student-table">
                        <thead><tr><th>SIRA</th><th>Ã–ÄRENCÄ°</th><th>DURUM</th><th>HEDEF</th><th>Ã‡ALIÅMA YILDIZI</th><th>TOPLAM</th></tr></thead>
                        <tbody id="studentTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="adminPanelMessages" class="hidden">
            <div class="card">
                <h4 style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">âœ‰ï¸ ÅABLON YÃ–NETÄ°MÄ° & GÃ–NDERÄ°M</h4>
                
                <div style="margin-bottom:20px;">
                    <h5 style="color:var(--text-sub); margin-bottom:10px;">ğŸ“š Hakan'Ä±n Mesaj Hazinesi (TÄ±kla ve Åablona Ekle)</h5>
                    <div class="msg-pool-container" id="predefinedMsgList">
                        </div>
                </div>

                <div style="background:#f8fafc; padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid #e2e8f0;">
                    <label style="font-size:0.8rem; font-weight:700; color:#64748b;">Yeni Åablon Ekle (Manuel):</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <select id="newTplType" class="input-modern" style="flex:1;">
                            <option value="Motive">ğŸš€ Motivasyon</option>
                            <option value="Tebrik">ğŸ† Tebrik</option>
                            <option value="Uyari">âš“ UyarÄ±</option>
                            <option value="Veli">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Veli</option>
                        </select>
                        <input type="text" id="newTplText" class="input-modern" placeholder="Mesaj metnini buraya yaz..." style="flex:3;">
                        <button class="btn-action" onclick="saveTemplate()" style="width:auto; margin:0; padding:10px 20px;">KAYDET ğŸ’¾</button>
                    </div>
                </div>

                <p style="color:#64748b; font-size:0.9rem; margin-bottom:10px;">KayÄ±tlÄ± Åablonlar (Silmek iÃ§in saÄŸ tÄ±kla):</p>
                <div id="templateButtonsArea" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px; max-height:200px; overflow-y:auto;">YÃ¼kleniyor...</div>
                
                <hr style="margin:20px 0; border-top:1px solid #eee;">
                
                <label style="font-weight:700; font-size:0.85rem; display:block; margin-bottom:5px;">Ã–ÄŸrenci SeÃ§in</label>
                <select id="msgStudentSelect" class="input-modern" style="margin-bottom:20px; text-align:left;"><option value="">Ã–ÄŸrenci SeÃ§...</option></select>
                <label style="font-weight:700; font-size:0.85rem; display:block; margin-bottom:5px;">MesajÄ±nÄ±z</label>
                <textarea id="msgContent" class="input-modern" style="height:120px; text-align:left; font-weight:normal;" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n veya yukarÄ±dan seÃ§in..."></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                    <div style="display:flex; gap:15px;">
                        <label style="display:flex; align-items:center; gap:5px; cursor:pointer;"><input type="radio" name="targetUser" value="student" checked onchange="handleTargetChange()"> Ã–ÄŸrenci</label>
                        <label style="display:flex; align-items:center; gap:5px; cursor:pointer;"><input type="radio" name="targetUser" value="parent" onchange="handleTargetChange()"> Veli</label>
                    </div>
                    <button class="btn-action" style="width:auto; padding:10px 30px; margin:0;" onclick="sendAdminMessage()">GÃ–NDER ğŸš€</button>
                </div>
            </div>
        </div>

        <div id="adminPanelHistory" class="hidden"><div class="card"><h4>ğŸ“œ GEÃ‡MÄ°Å</h4><div id="adminMsgHistoryList" style="max-height:400px; overflow-y:auto;"></div></div></div>
        
        <div id="adminPanelClan" class="hidden">
            <div class="card">
                <h4>â›º Ä°STEKLER</h4>
                <div id="adminClanRequestList"></div>
                <hr style="margin:15px 0;">
                <div id="adminMemberRequestList"></div>
            </div>
            <div class="card">
                <h4>ğŸ•ï¸ AKTÄ°F OTAÄLAR</h4>
                <div id="adminActiveClansList"></div>
            </div>
        </div>
        
        <div id="adminPanelOwl" class="hidden"><div class="card"><h4>ğŸ¦‰ BAYKUÅ YÃ–NETÄ°MÄ°</h4><div style="display:flex; gap:10px;"><input type="text" id="newOwlMsg" class="input-modern" placeholder="Yeni SÃ¶z..." style="flex:1;"><button class="btn-action" onclick="addOwlMessage()" style="width:auto;">EKLE</button></div></div><div class="card"><h4>ğŸ“œ SÃ–ZLER (<span id="owlMsgCount">0</span>)</h4><div id="adminOwlList" style="max-height:400px; overflow-y:auto;"></div></div></div>
        
        <div id="adminPanelCapsules" class="hidden">
            <div class="card">
                <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin:0; border:none;">â³ ZAMAN KAPSÃœLLERÄ°</h4>
                        <label style="font-size:0.8rem; color:#666; cursor:pointer;">
                            <input type="checkbox" onchange="toggleAllCapsules(this)"> TÃ¼mÃ¼nÃ¼ SeÃ§
                        </label>
                    </div>
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <button onclick="adminBulkUpdateCapsuleDate()" class="btn-smart" style="background:#4f46e5; color:white; flex:1;">ğŸ“… TARÄ°H DEÄÄ°ÅTÄ°R</button>
                        <button onclick="adminBulkUnlockCapsules()" class="btn-smart" style="background:#10b981; color:white; flex:1;">ğŸ”“ KÄ°LÄ°TLERÄ° AÃ‡</button>
                        <button onclick="adminBulkLockCapsules()" class="btn-smart" style="background:#f59e0b; color:white; flex:1;">ğŸ”’ TEKRAR KÄ°LÄ°TLE</button>
                        <button onclick="adminDeleteSelectedCapsules()" class="btn-smart" style="background:#ef4444; color:white; flex:1;">ğŸ—‘ï¸ SÄ°L (CEZALI)</button>
                    </div>
                </div>
                <div id="adminCapsuleList" style="max-height:500px; overflow-y:auto;">
                    YÃ¼kleniyor...
                </div>
            </div>
        </div>
    </div>
    
    <div id="modalAdminStudentDetail" class="modal hidden fade-in">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="detailNameTitle" style="margin:0; color:var(--primary);">Ã–ÄŸrenci DetayÄ±</h3>
                <button onclick="adminDeleteStudent()" style="background:#fee2e2; color:red; border:none; padding:8px 15px; border-radius:10px; font-weight:bold; cursor:pointer; font-size:0.8rem;">âš ï¸ SÄ°STEMDEN SÄ°L</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                <div><label style="font-size:0.75rem; font-weight:bold; color:#64748b;">Toplam Puan</label><input type="number" id="detailPoints" class="input-modern" style="margin:0;"></div>
                <div><label style="font-size:0.75rem; font-weight:bold; color:#64748b;">Toplam Dakika</label><input type="number" id="detailMinutes" class="input-modern" style="margin:0;"></div>
                <div><label style="font-size:0.75rem; font-weight:bold; color:#64748b;">HaftalÄ±k Hedef</label><input type="number" id="detailGoal" class="input-modern" style="margin:0;"></div>
            </div>
            <button class="btn-action" onclick="saveAdminStudentDetail()" style="margin-bottom:25px; padding:12px;">BÄ°LGÄ°LERÄ° GÃœNCELLE âœ…</button>
            <input type="hidden" id="detailUid">
            <h4 style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">ğŸ“‹ TÃ¼m Hareket GeÃ§miÅŸi (Ders, Ceza, Bonus...)</h4>
            <div id="detailSessionList" style="max-height:300px; overflow-y:auto; background:#f8fafc; padding:10px; border-radius:15px; border:1px solid #e2e8f0;">YÃ¼kleniyor...</div>
            <button onclick="document.getElementById('modalAdminStudentDetail').classList.add('hidden')" style="margin-top:15px; width:100%; padding:12px; background:#e2e8f0; border:none; border-radius:12px; font-weight:bold; color:#475569; cursor:pointer;">Pencereyi Kapat</button>
        </div>
    </div>

    <div id="modalStudentSelector" class="modal hidden fade-in">
        <div class="modal-content">
            <h3 id="selectorTitle">Ã–ÄŸrenci SeÃ§imi</h3>
            <div style="display:flex; justify-content:flex-end; margin-bottom:10px;"><button onclick="toggleAllCheckboxes()" style="border:none;background:none;color:var(--primary);font-weight:bold;cursor:pointer;">TÃ¼mÃ¼nÃ¼ SeÃ§/KaldÄ±r</button></div>
            <div id="selectorList" style="max-height:300px; overflow-y:auto; padding:10px; border:1px solid #eee;"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-action" onclick="sendBatchSelection()" style="flex:1;">GÃ–NDER ğŸš€</button>
                <button onclick="document.getElementById('modalStudentSelector').classList.add('hidden')" style="background:#fee2e2; color:red; border:none; padding:15px; border-radius:20px; font-weight:bold; cursor:pointer;">Ä°ptal</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, updateDoc, addDoc, deleteDoc, getDocs, query, where, onSnapshot, serverTimestamp, increment, deleteField, runTransaction, orderBy, limit, writeBatch, collectionGroup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBkJg6hiMPcgM-bywHjUCKdD8CapA1VDHk", authDomain: "ogrencitakip-bcdbd.firebaseapp.com", projectId: "ogrencitakip-bcdbd", storageBucket: "ogrencitakip-bcdbd.firebasestorage.app", messagingSenderId: "74510222174", appId: "1:74510222174:web:9d379386762064ee0f45cf" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
    const ADMIN_EMAIL = "mremzi@gmail.com";

    let currentUser=null, globalUserList=[], unsubAdminUsers = null, unsubAdminMessages=null, templateUnsub=null, unsubAdminCapsules=null, unsubAdminOwl=null;
    let currentBatchType = "";

    const PREDEFINED_MSGS = [
        {type:'Motive', text:'ğŸš€ BaÅŸarÄ±, her gÃ¼n tekrarlanan kÃ¼Ã§Ã¼k Ã§abalarÄ±n toplamÄ±dÄ±r. Asla vazgeÃ§me!'},
        {type:'Motive', text:'ğŸŒŸ Potansiyelinin farkÄ±nda mÄ±sÄ±n? Yapabileceklerinin sÄ±nÄ±rÄ± yok!'},
        {type:'Motive', text:'ğŸ”¥ Zorluklar seni yÄ±ldÄ±rmasÄ±n, onlar seni gÃ¼Ã§lendirmek iÃ§in var.'},
        {type:'Motive', text:'ğŸ’ª BugÃ¼n yaptÄ±ÄŸÄ±n Ã§alÄ±ÅŸmalar, yarÄ±n kuracaÄŸÄ±n hayallerin temelidir.'},
        {type:'Motive', text:'â³ Zaman akÄ±p gidiyor, onu en iyi ÅŸekilde deÄŸerlendiren sensin!'},
        {type:'Tebrik', text:'ğŸ† Harika gidiyorsun! Bu azminle zirveye Ã§ok yakÄ±ÅŸtÄ±n.'},
        {type:'Tebrik', text:'âœ¨ HaftalÄ±k hedefini paramparÃ§a ettin! Seninle gurur duyuyoruz.'},
        {type:'Tebrik', text:'ğŸ‘ Ã‡alÄ±ÅŸmalarÄ±ndaki istikrar gÃ¶z kamaÅŸtÄ±rÄ±yor. Bravo!'},
        {type:'Tebrik', text:'ğŸ… Yeni rÃ¼tben hayÄ±rlÄ± olsun! Bu onuru sonuna kadar hak ettin.'},
        {type:'Uyari', text:'âš“ Kaptan! Gemin yavaÅŸlÄ±yor. Rotana geri dÃ¶nmelisin.'},
        {type:'Uyari', text:'âš ï¸ Son gÃ¼nlerde Ã§alÄ±ÅŸmalarÄ±nda dÃ¼ÅŸÃ¼ÅŸ var. Toparlanma zamanÄ±!'},
        {type:'Uyari', text:'ğŸ‘€ GÃ¶zlerimiz seni arÄ±yor. Hadi sahalara geri dÃ¶n!'},
        {type:'Veli', text:'SayÄ±n Velimiz, Ã¶ÄŸrencinizin baÅŸarÄ±sÄ± iÃ§in desteÄŸiniz Ã§ok kÄ±ymetli. Ä°lginize teÅŸekkÃ¼rler.'},
        {type:'Veli', text:'SayÄ±n Velimiz, Ã¶ÄŸrenciniz bu hafta harika bir performans sergiledi. Tebrik ederiz.'},
        {type:'Veli', text:'SayÄ±n Velimiz, Ã¶ÄŸrencinizin Ã§alÄ±ÅŸma temposunda bir dÃ¼ÅŸÃ¼ÅŸ gÃ¶zlemledik. DesteÄŸinizi rica ederiz.'}
    ];

    onAuthStateChanged(auth, async(user)=>{
        if(user){
            if(user.email !== ADMIN_EMAIL){ 
                await signOut(auth);
                Swal.fire({ title: "Yetkisiz GiriÅŸ", text: "BurasÄ± YÃ¶netici Kulesidir!", icon: "error", confirmButtonText: "Tamam" });
                return; 
            }
            currentUser=user; 
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            try { initAdmin(); } catch (err) { console.error(err); }
        } else { 
            currentUser=null;
            document.getElementById('adminScreen').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('authLog').innerText = "";
        }
    });

    window.handleLogin = async () => {
        const btn = document.querySelector('#authScreen .btn-action'); const errDiv = document.getElementById('authError');
        btn.innerText = "Kontrol Ediliyor..."; btn.disabled = true; document.getElementById('authLog').style.display='block'; document.getElementById('authLog').innerText="BaÄŸlanÄ±yor...";
        const e = document.getElementById('email').value.trim(); const p = document.getElementById('password').value;
        try { await signInWithEmailAndPassword(auth,e,p); } catch(err){ errDiv.style.display='block'; errDiv.innerText = "Hata: " + err.message; btn.innerText = "GÄ°RÄ°Å YAP"; btn.disabled = false; }
    };
    
    window.handleLogout = () => { 
        if(unsubAdminUsers) unsubAdminUsers(); 
        signOut(auth).then(() => {
            document.getElementById('adminScreen').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('password').value = "";
            document.getElementById('authLog').innerText = "Oturum KapatÄ±ldÄ±.";
        });
    };

    function initAdmin(){ 
        if(unsubAdminUsers) unsubAdminUsers(); 
        unsubAdminUsers = onSnapshot(collection(db,"users"), (snap)=>{ 
            globalUserList=[]; const select = document.getElementById('msgStudentSelect'); select.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§...</option>'; 
            snap.forEach(d=>{ const dt = d.data(); if(dt.email !== ADMIN_EMAIL) { dt.xp = dt.xp||(dt.bilgePoints||0); globalUserList.push({id:d.id, ...dt}); select.innerHTML += `<option value="${d.id}">${dt.displayName || 'Ä°simsiz'}</option>`; } }); 
            globalUserList.sort((a,b) => (b.totalMinutes||0) - (a.totalMinutes||0)); 
            renderAdminDashboard(); 
        }); 
        listenAdminClanRequests(); listenAdminMessages(); listenTemplates(); listenAdminCapsules(); listenAdminOwlMessages(); renderMsgPool();
    }

    function renderMsgPool() {
        const pool = document.getElementById('predefinedMsgList'); pool.innerHTML = "";
        PREDEFINED_MSGS.forEach(m => {
            let color = '#64748b'; if(m.type==='Motive') color='#10b981'; else if(m.type==='Tebrik') color='#f59e0b'; else if(m.type==='Uyari') color='#f97316'; else if(m.type==='Veli') color='#3b82f6';
            pool.innerHTML += `<div class="msg-pool-item" onclick="document.getElementById('newTplText').value='${m.text}'; document.getElementById('newTplType').value='${m.type}';">
                <span class="msg-type-badge" style="background:${color}">${m.type}</span> <span>${m.text}</span>
            </div>`;
        });
    }

    function renderAdminDashboard(){
        const table = document.getElementById('studentTableBody'); if(!table) return; table.innerHTML = "";
        let riskCount = 0; let flyCount = 0; let tm=0, ta=0; const td=new Date().toDateString();
        if(globalUserList.length === 0) { table.innerHTML = "<tr><td colspan='6' style='text-align:center;'>HenÃ¼z Ã¶ÄŸrenci yok.</td></tr>"; return; }
        globalUserList.forEach((u,i) => {
            const last = u.lastStudyDate ? (u.lastStudyDate.toDate?u.lastStudyDate.toDate():new Date(u.lastStudyDate)) : null;
            let stT="Ä°yi", stC="status-iyi", ic="ğŸ‘";
            if(!last || (new Date()-last)/(86400000) > 3) { stT="Riskli"; stC="status-riskli"; ic="âš ï¸"; riskCount++; } 
            else if((u.totalMinutes||0) > 1000) { stT="Lider"; stC="status-lider"; ic="ğŸ‘‘"; flyCount++; }
            tm+=(u.totalMinutes||0); if(last && last.toDateString()===td) ta++;
            table.innerHTML += `<tr onclick="openAdminStudentDetail('${u.id}')"><td style="color:#94a3b8; font-weight:700;">#${i+1}</td><td style="font-weight:700;">${u.displayName||"Ä°simsiz"}</td><td><span class="status-badge ${stC}">${ic} ${stT}</span></td><td style="font-weight:bold; color:#64748b;">${u.weeklyGoal || 1000}dk</td><td style="color:#6366f1; font-weight:800;">${u.xp||0} âœ¨</td><td>${Math.floor((u.totalMinutes||0)/60)}s ${(u.totalMinutes||0)%60}dk</td></tr>`;
        });
        document.getElementById('adminTotalStudents').innerText = globalUserList.length;
        document.getElementById('adminReportText').innerHTML = `Ä°ncelemelerime gÃ¶re <strong style="color:#b91c1c;">${riskCount}</strong> Ã¶ÄŸrenci geride kaldÄ±, <strong style="color:#047857;">${flyCount}</strong> Ã¶ÄŸrenci ise uÃ§uÅŸa geÃ§ti.`;
        document.getElementById('adminTotalHours').innerText = Math.floor(tm/60); document.getElementById('adminActiveToday').innerText = ta;
        renderRisingStars(globalUserList); renderAdminChart(globalUserList);
    }
    
    function renderAdminChart(users) {
        const topUsers = users.slice(0, 15);
        Highcharts.chart('adminLeaderboardChart', {
            chart: { type: 'column', options3d: { enabled: true, alpha: 10, beta: 25, depth: 70 }, backgroundColor: null },
            title: { text: null },
            subtitle: { text: null },
            xAxis: { categories: topUsers.map(u => u.displayName), labels: { skew3d: true, style: { fontSize: '12px', fontWeight: 'bold' } } },
            yAxis: { title: { text: 'Dakika (dk)', skew3d: true }, min: 0 },
            plotOptions: { column: { depth: 25, colorByPoint: true, borderRadius: 5 } }, 
            credits: { enabled: false },
            series: [{ name: 'Ã‡alÄ±ÅŸma SÃ¼resi', data: topUsers.map(u => u.totalMinutes), showInLegend: false }]
        });
    }

    function listenTemplates() {
        if(templateUnsub) templateUnsub();
        templateUnsub = onSnapshot(query(collection(db, "msg_templates"), orderBy("createdAt", "desc")), (snap) => {
            const area = document.getElementById('templateButtonsArea'); area.innerHTML = "";
            if(snap.empty) { seedDefaultTemplates(); return; }
            snap.forEach(d => {
                const t = d.data(); let color = "#e2e8f0"; if(t.type === 'Motive') color = "#10b981"; else if(t.type === 'Tebrik') color = "#f59e0b"; else if(t.type === 'Uyari') color = "#f97316"; else if(t.type === 'Veli') color = "#3b82f6";
                const btn = document.createElement('button'); btn.className = 'btn-lib'; btn.style.borderLeft = `4px solid ${color}`; btn.innerHTML = `${t.text.substring(0, 30)}...`;
                btn.onclick = () => setMsgFromTemplate(t.text, t.type); btn.oncontextmenu = (e) => { e.preventDefault(); deleteTemplate(d.id); }; area.appendChild(btn);
            });
        });
    }
    
    function listenAdminCapsules() { 
        if(unsubAdminCapsules) unsubAdminCapsules(); 
        const q = query(collectionGroup(db, 'timecapsule')); 
        unsubAdminCapsules = onSnapshot(q, (snap) => { 
            const list = document.getElementById('adminCapsuleList'); list.innerHTML = ""; 
            if(snap.empty) { list.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>HenÃ¼z hiÃ§ kapsÃ¼l yok.</div>"; return; } 
            
            const capsules = [];
            snap.forEach(d => capsules.push({path: d.ref.path, ...d.data()}));
            capsules.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

            capsules.forEach(data => { 
                const isLocked = new Date() < new Date(data.unlockDate); 
                const statusIcon = isLocked ? "ğŸ”’ KÄ°LÄ°TLÄ°" : "ğŸ”“ AÃ‡IK"; 
                const statusClass = isLocked ? "color:#b91c1c; background:#fee2e2;" : "color:#15803d; background:#dcfce7;"; 
                let stName = data.userName; if(!stName || stName === "Ã–ÄŸrenci") { const u = globalUserList.find(x => x.id === data.userId); if(u) stName = u.displayName; else stName = "Bilinmeyen (" + data.userId.substring(0,4) + ")"; }
                
                list.innerHTML += `
                <div style="background:white; border:1px solid #e2e8f0; border-radius:16px; padding:15px; margin-bottom:15px; display:flex; gap:10px;">
                    <div style="display:flex; align-items:center;"><input type="checkbox" class="chk-capsule" value="${data.path}" data-uid="${data.userId}" style="transform:scale(1.3); cursor:pointer;"></div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-weight:800; color:var(--primary); font-size:1rem;">ğŸ‘¤ ${stName}<span style="font-size:0.75rem; color:#64748b; font-weight:normal; margin-left:5px;">ğŸ“… AÃ§Ä±lÄ±ÅŸ: ${data.unlockDate}</span></div>
                            <span style="padding:2px 8px; border-radius:8px; font-size:0.7rem; font-weight:bold; ${statusClass}">${statusIcon}</span>
                        </div>
                        <div style="background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:10px; font-style:italic; color:#334155; font-size:0.9rem;">"${data.content}"</div>
                        <div style="display:flex; gap:5px; justify-content:flex-end;">
                            <button onclick="adminChangeCapsuleDate('${data.path}', '${data.unlockDate}')" class="btn-smart" style="background:#e0e7ff; color:#4338ca;">ğŸ“… Tarih</button>
                            <button onclick="adminSetCapsuleLock('${data.path}', false)" class="btn-smart" style="background:#dbeafe; color:#1e40af;">ğŸ”“ AÃ§</button>
                            <button onclick="adminSetCapsuleLock('${data.path}', true)" class="btn-smart" style="background:#fff7ed; color:#c2410c;">ğŸ”’ Kilitle</button>
                            <button onclick="adminDeleteCapsule('${data.path}', '${data.userId}')" class="btn-smart" style="background:#fee2e2; color:#991b1b;">ğŸ—‘ï¸ Sil (-50p)</button>
                        </div>
                    </div>
                </div>`; 
            }); 
        }); 
    }

    window.openAdminStudentDetail = async (uid) => { 
        const user = globalUserList.find(x => x.id === uid); if(!user) return;
        document.getElementById('detailUid').value = uid; document.getElementById('detailNameTitle').innerText = user.displayName; document.getElementById('detailPoints').value = user.xp || 0; document.getElementById('detailMinutes').value = user.totalMinutes || 0; document.getElementById('detailGoal').value = user.weeklyGoal || 1000; 
        const list = document.getElementById('detailSessionList'); list.innerHTML = "<div style='text-align:center; color:#999;'>GeÃ§miÅŸ YÃ¼kleniyor...</div>"; 
        
        const q = query(collection(db, "users", uid, "sessions"), orderBy("createdAt", "desc"), limit(50)); 
        const snap = await getDocs(q); list.innerHTML = ""; 
        if(snap.empty) { list.innerHTML = "<div style='text-align:center;'>KayÄ±t yok.</div>"; }
        
        snap.forEach(d => { 
            const s = d.data(); 
            let typeLabel = "Ders"; let typeColor = "#e0e7ff"; let typeTextCol = "#4338ca";
            if(s.type === 'pomodoro') { typeLabel = "SayaÃ§"; typeColor = "#dcfce7"; typeTextCol = "#166534"; }
            else if(s.type === 'arena') { typeLabel = "Arena"; typeColor = "#fee2e2"; typeTextCol = "#991b1b"; }
            else if(s.type === 'bonus') { typeLabel = "Bonus"; typeColor = "#fef3c7"; typeTextCol = "#b45309"; }
            else if(s.type === 'penalty') { typeLabel = "Ceza"; typeColor = "#f3f4f6"; typeTextCol = "#1f2937"; }

            list.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:10px; margin-bottom:8px; border-radius:10px; border:1px solid #eee;">
                <div>
                    <div style="font-weight:bold; color:var(--text-main); font-size:0.9rem;">
                        <span style="background:${typeColor}; color:${typeTextCol}; padding:2px 6px; border-radius:4px; font-size:0.7rem; margin-right:5px;">${typeLabel}</span>
                        ${s.subject || 'Genel'} (${s.duration || 0} dk)
                    </div>
                    <div style="font-size:0.75rem; color:#94a3b8;">${s.dateStr || s.createdAt?.toDate().toLocaleDateString()} â€¢ Puan: <strong>${s.points}</strong></div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="adminEditSession('${uid}', '${d.id}', '${s.duration||0}', '${s.points||0}')" style="background:#e0e7ff; color:#4338ca; border:none; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.75rem; font-weight:bold;">âœï¸</button>
                    <button onclick="adminDeleteSession('${uid}', '${d.id}', '${s.duration||0}', '${s.points||0}')" style="background:#fee2e2; color:#b91c1c; border:none; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.75rem; font-weight:bold;">ğŸ—‘ï¸</button>
                </div>
            </div>`; 
        });
        document.getElementById('modalAdminStudentDetail').classList.remove('hidden'); 
    };

    window.toggleAllCapsules = (source) => { document.querySelectorAll('.chk-capsule').forEach(c => c.checked = source.checked); };
    window.adminDeleteSelectedCapsules = async () => {
        const selected = document.querySelectorAll('.chk-capsule:checked'); if(selected.length === 0) return Swal.fire("SeÃ§im Yok", "", "warning");
        if(!confirm(`${selected.length} kapsÃ¼lÃ¼ silmek ve 50'ÅŸer puan ceza kesmek Ã¼zeresin?`)) return;
        const batch = writeBatch(db);
        selected.forEach(chk => {
            const path = chk.value; const uid = chk.dataset.uid; const segments = path.split('/');
            batch.delete(doc(db, segments[0], segments[1], segments[2], segments[3]));
            batch.update(doc(db, "users", uid), { xp: increment(-50), gold: increment(-50) });
        });
        await batch.commit(); Swal.fire("Ä°ÅŸlem Tamam", "", "success");
    };
    window.adminBulkUpdateCapsuleDate = async () => {
        const selected = document.querySelectorAll('.chk-capsule:checked'); 
        const { value: newDate } = await Swal.fire({ title: 'Yeni Tarih', input: 'date', showCancelButton: true }); 
        if (newDate) { 
            const batch = writeBatch(db);
            const targets = selected.length > 0 ? selected : document.querySelectorAll('.chk-capsule'); 
            targets.forEach(chk => { const s = chk.value.split('/'); batch.update(doc(db, s[0], s[1], s[2], s[3]), { unlockDate: newDate }); });
            await batch.commit(); Swal.fire("Tarihler GÃ¼ncellendi", "", "success");
        } 
    };
    window.adminBulkUnlockCapsules = async () => { updateCapsuleLocks(false); };
    window.adminBulkLockCapsules = async () => { updateCapsuleLocks(true); };
    async function updateCapsuleLocks(lock) {
        const selected = document.querySelectorAll('.chk-capsule:checked');
        const date = lock ? "2026-01-01" : "2023-01-01"; 
        const batch = writeBatch(db);
        const targets = selected.length > 0 ? selected : document.querySelectorAll('.chk-capsule');
        targets.forEach(chk => { const s = chk.value.split('/'); batch.update(doc(db, s[0], s[1], s[2], s[3]), { unlockDate: date }); });
        await batch.commit(); Swal.fire(lock ? "Kilitlendi" : "Kilitler AÃ§Ä±ldÄ±", "", "success");
    }
    
    window.adminDeleteCapsule = async (path, uid) => { if(!confirm("Silmek ve ceza kesmek istiyor musun?")) return; const s=path.split('/'); await deleteDoc(doc(db,s[0],s[1],s[2],s[3])); await updateDoc(doc(db,"users",uid),{xp:increment(-50),gold:increment(-50)}); };
    window.adminChangeCapsuleDate = async (path, cur) => { const {value:nD} = await Swal.fire({title:'Yeni Tarih', html:`<input type="date" id="swal-date" class="swal2-input" value="${cur}">`, preConfirm:()=>document.getElementById('swal-date').value}); if(nD) { const s=path.split('/'); await updateDoc(doc(db,s[0],s[1],s[2],s[3]),{unlockDate:nD}); } };
    window.adminSetCapsuleLock = async (path, lock) => { const d = lock ? "2026-01-10" : "2023-01-01"; const s=path.split('/'); await updateDoc(doc(db,s[0],s[1],s[2],s[3]),{unlockDate:d}); };

    window.adminEditSession = async (uid, sid, oldDur, oldPts) => { 
        const { value: formValues } = await Swal.fire({ 
            title: 'KayÄ±t DÃ¼zenle', 
            html: `
                <div style="text-align:left; font-size:0.9rem; color:#555; margin-bottom:5px;">SÃ¼re (Dakika)</div>
                <input id="swal-input1" class="swal2-input" type="number" placeholder="Dakika" value="${oldDur}" style="margin-top:0;">
                <div style="text-align:left; font-size:0.9rem; color:#555; margin-bottom:5px; margin-top:15px;">Puan</div>
                <input id="swal-input2" class="swal2-input" type="number" placeholder="Puan" value="${oldPts}" style="margin-top:0;">
            `, 
            focusConfirm: false, 
            showCancelButton: true, 
            confirmButtonText: 'KAYDET',
            preConfirm: () => [document.getElementById('swal-input1').value, document.getElementById('swal-input2').value] 
        }); 
        
        if (formValues) { 
            const nD = parseInt(formValues[0]); 
            const nP = parseInt(formValues[1]); 
            await updateDoc(doc(db, "users", uid, "sessions", sid), { duration: nD, points: nP }); 
            await updateDoc(doc(db, "users", uid), { totalMinutes: increment(nD-oldDur), xp: increment(nP-oldPts), gold: increment(nP-oldPts) }); 
            Swal.fire("GÃ¼ncellendi", "Puan ve sÃ¼re baÅŸarÄ±yla deÄŸiÅŸtirildi.", "success"); 
            openAdminStudentDetail(uid); 
        } 
    };

    window.adminDeleteSession = async (uid, sid, dur, pts) => { if(!confirm("KayÄ±t silinecek ve puan dÃ¼ÅŸÃ¼lecek?")) return; await deleteDoc(doc(db, "users", uid, "sessions", sid)); await updateDoc(doc(db, "users", uid), { totalMinutes: increment(-dur), xp: increment(-pts), gold: increment(-pts) }); openAdminStudentDetail(uid); };
    window.adminDeleteStudent = async () => { const uid=document.getElementById('detailUid').value; if(!confirm("Ã–ÄŸrenciyi silmek Ã¼zeresin!")) return; await deleteDoc(doc(db,"users",uid)); Swal.fire("Silindi","","success"); document.getElementById('modalAdminStudentDetail').classList.add('hidden'); };
    window.saveAdminStudentDetail = async () => { const uid=document.getElementById('detailUid').value; await updateDoc(doc(db,"users",uid),{xp:parseInt(document.getElementById('detailPoints').value), gold:parseInt(document.getElementById('detailPoints').value), totalMinutes:parseInt(document.getElementById('detailMinutes').value), weeklyGoal:parseInt(document.getElementById('detailGoal').value)}); Swal.fire("Kaydedildi","","success"); document.getElementById('modalAdminStudentDetail').classList.add('hidden'); };
    
    window.analyzeAndWarn = () => { const inactive = globalUserList.filter(u => !u.lastStudyDate || (new Date() - u.lastStudyDate.toDate()) > 3 * 24 * 60 * 60 * 1000); if(inactive.length === 0) return Swal.fire("Harika", "Geride kalan yok!", "info"); openSelectorModal(inactive, 'warn', "âš ï¸ Geride KalanlarÄ± Uyar"); };
    window.analyzeAndCongratulate = () => { const stars = globalUserList.filter(u => u.totalMinutes > 1000); if(stars.length === 0) return Swal.fire("HenÃ¼z Yok", "Kutlanacak lider yok.", "info"); openSelectorModal(stars, 'congrats', "ğŸŒŸ YÄ±ldÄ±zlarÄ± Kutla"); };
    function openSelectorModal(users, type, title) { currentBatchType = type; document.getElementById('selectorTitle').innerText = title; const list = document.getElementById('selectorList'); list.innerHTML = ""; users.forEach(u => { const info = type === 'warn' ? `${Math.floor((new Date() - (u.lastStudyDate ? u.lastStudyDate.toDate() : 0)) / (1000*60*60*24))} gÃ¼n yok` : `${u.totalMinutes} dk`; list.innerHTML += `<label class="selector-item"><input type="checkbox" class="chk-student" value="${u.id}" checked><span class="selector-name">${u.displayName}</span><span class="selector-info">${info}</span></label>`; }); document.getElementById('modalStudentSelector').classList.remove('hidden'); }
    window.sendBatchSelection = async () => { const checkboxes = document.querySelectorAll('.chk-student:checked'); if(checkboxes.length === 0) return Swal.fire("SeÃ§im Yok", "", "warning"); const btn = document.querySelector('#modalStudentSelector .btn-action'); btn.disabled = true; try { const batch = writeBatch(db); let msgContent = currentBatchType === 'warn' ? "Nerelerdesin? TÃ¼ylerim endiÅŸeden dÃ¶kÃ¼lÃ¼yor! ğŸ¦‰" : "KanatlarÄ±mÄ±n altÄ±na rÃ¼zgar oldun! HaftalÄ±k hedefini ÅŸimdiden geÃ§tin! ğŸ†"; checkboxes.forEach(chk => { batch.set(doc(collection(db, "messages")), { toUid: chk.value, content: msgContent, read: false, type: "auto", createdAt: serverTimestamp() }); }); await batch.commit(); document.getElementById('modalStudentSelector').classList.add('hidden'); Swal.fire("BaÅŸarÄ±lÄ±", `${checkboxes.length} mesaj gÃ¶nderildi.`, "success"); } catch(e) { Swal.fire("Hata", "GÃ¶nderilemedi.", "error"); } finally { btn.disabled = false; } };
    window.toggleAllCheckboxes = () => { const checkboxes = document.querySelectorAll('.chk-student'); const allChecked = Array.from(checkboxes).every(c => c.checked); checkboxes.forEach(c => c.checked = !allChecked); };
    window.recalculateAllScores = async () => { if(!confirm("TÃ¼m puanlar yeniden hesaplanacak!")) return; const statusDiv = document.getElementById('repairStatus'); statusDiv.style.display = 'block'; try { for (const user of globalUserList) { statusDiv.innerText = `Ä°nceleniyor: ${user.displayName}`; const snap = await getDocs(collection(db, "users", user.id, "sessions")); let nM = 0; let nXP = 0; const batch = writeBatch(db); const hasClan = !!user.clanId; snap.forEach(doc => { const d = doc.data(); const dur = parseInt(d.duration)||0; let m = 1.0; if(d.type==='pomodoro') m=1.5; if(d.type==='arena') m=2.0; const pts = Math.ceil(dur * (m + (hasClan?0.5:0))); nM+=dur; nXP+=pts; if(d.points!==pts) batch.update(doc.ref, {points:pts}); }); batch.update(doc(db,"users",user.id), {totalMinutes:nM, xp:nXP, gold:nXP}); await batch.commit(); } statusDiv.innerText = "TamamlandÄ±!"; Swal.fire("Zafer!", "Puanlar gÃ¼ncellendi.", "success"); } catch(e) { Swal.fire("Hata", e.message, "error"); } };
    window.saveTemplate = async () => { const t = document.getElementById('newTplText').value.trim(); if(!t) return; await addDoc(collection(db, "msg_templates"), { type: document.getElementById('newTplType').value, text: t, createdAt: serverTimestamp() }); document.getElementById('newTplText').value=""; };
    window.deleteTemplate = async (id) => { if(confirm("Sil?")) await deleteDoc(doc(db, "msg_templates", id)); };
    window.setMsgFromTemplate = (t, type) => { const ta = document.getElementById('msgContent'); const rP = document.querySelector('input[value="parent"]'); const rS = document.querySelector('input[value="student"]'); if(type==='Veli'){rP.checked=true; ta.value="KÄ±ymetli velimiz: "+t;}else{rS.checked=true; ta.value=t;} };
    window.handleTargetChange = () => { const isP = document.querySelector('input[value="parent"]').checked; const ta = document.getElementById('msgContent'); let v = ta.value; if(isP){ if(!v.startsWith("KÄ±ymetli velimiz:")) ta.value="KÄ±ymetli velimiz: "+v; } else { if(v.startsWith("KÄ±ymetli velimiz: ")) ta.value=v.replace("KÄ±ymetli velimiz: ", ""); } };
    async function seedDefaultTemplates() { const b = writeBatch(db); PREDEFINED_MSGS.forEach(x=>{ b.set(doc(collection(db,"msg_templates")),{...x,createdAt:serverTimestamp()}); }); await b.commit(); }
    function renderRisingStars(u) { const c=document.getElementById('risingStarsContainer'); c.innerHTML=""; u.filter(x=>x.lastStudyDate).sort((a,b)=>b.totalMinutes-a.totalMinutes).slice(0,5).forEach(x=>c.innerHTML+=`<div class="star-card" onclick="openAdminStudentDetail('${x.id}')">ğŸš€ ${x.displayName}</div>`); }
    
    // --- GÃœNCELLENEN OTAG YONETIMI KISMI ---
    function listenAdminClanRequests() { 
        onSnapshot(collection(db,"clan_requests"), s=>{ 
            document.getElementById('adminClanRequestList').innerHTML = s.docs.map(d=>`
                <div>${d.data().name} <button onclick="approveClan('${d.id}','${d.data().leader}','${d.data().name}','${d.data().icon}')">âœ“</button>
                <button onclick="rejectRequest('clan_requests','${d.id}')">âœ•</button></div>`
            ).join(''); 
        }); 
        onSnapshot(collection(db,"member_requests"), s=>{ 
            document.getElementById('adminMemberRequestList').innerHTML = s.docs.map(d=>`
                <div>${d.data().userName}->${d.data().clanName} <button onclick="approveMember('${d.id}','${d.data().userId}','${d.data().clanId}')">âœ“</button>
                <button onclick="rejectRequest('member_requests','${d.id}')">âœ•</button></div>`
            ).join(''); 
        }); 
        
        onSnapshot(collection(db,"clans"), s=>{ 
            document.getElementById('adminActiveClansList').innerHTML = s.docs.map(d=>`
                <div class="clan-admin-item">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <strong>
                            ${d.data().icon} ${d.data().name} 
                            <span style="color:#f59e0b; font-size:0.9rem; margin-left:10px;">â­ ${d.data().totalScore || 0} Puan</span>
                        </strong> 
                        <button onclick="deleteClan('${d.id}')" style="background:#fee2e2;color:red;border:none;padding:5px 10px;border-radius:5px;font-weight:bold;">SÄ°L</button>
                    </div>
                    <div id="clan-members-${d.id}" style="margin-top:5px; padding:5px; background:#f8fafc; font-size:0.8rem; color:#666;">YÃ¼kleniyor...</div>
                </div>`
            ).join(''); 
            s.docs.forEach(docSnap => loadClanMembersForAdmin(docSnap.id)); 
        }); 
    }

    async function loadClanMembersForAdmin(clanId) { const q = query(collection(db, "users"), where("clanId", "==", clanId)); const snap = await getDocs(q); let html = ""; snap.forEach(u => { html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px;"><span>ğŸ‘¤ ${u.data().displayName}</span><button onclick="kickMember('${u.id}', '${clanId}')" style="color:red; background:none; border:none; cursor:pointer; font-weight:bold;">[AT]</button></div>`; }); const el = document.getElementById(`clan-members-${clanId}`); if(el) el.innerHTML = html || "<i>Ãœye yok.</i>"; }
    window.kickMember = async (uid, cid) => { if(!confirm("Ãœyeyi otaÄŸdan atmak istiyor musun?")) return; await updateDoc(doc(db, "users", uid), { clanId: deleteField() }); await updateDoc(doc(db, "clans", cid), { memberCount: increment(-1) }); loadClanMembersForAdmin(cid); Swal.fire("AtÄ±ldÄ±", "", "success"); };
    window.deleteClan = async (cid) => { if(!confirm("OtaÄŸÄ± tamamen silmek istiyor musun?")) return; await deleteDoc(doc(db, "clans", cid)); };
    function listenAdminMessages() { onSnapshot(query(collection(db,"messages"), orderBy("createdAt","desc"), limit(50)), s=>{ document.getElementById('adminMsgHistoryList').innerHTML = s.docs.map(d=>{ const m = d.data(); const msgType = m.type || 'admin'; const senderIcon = msgType === 'admin' ? 'ğŸ‘¨â€ğŸ« Hakan' : 'ğŸ¦‰ Bilge BaykuÅŸ'; return `<div style="border-bottom:1px solid #eee; padding:5px;"><small style="color:#666;">${senderIcon}</small> â <strong>${globalUserList.find(u=>u.id===m.toUid)?.displayName||'??'}</strong>: ${m.content}</div>`; }).join(''); }); }
    function listenAdminOwlMessages() { unsubAdminOwl = onSnapshot(query(collection(db, "owl_messages"), orderBy("createdAt", "desc")), (snap) => { const list = document.getElementById('adminOwlList'); list.innerHTML = ""; document.getElementById('owlMsgCount').innerText = snap.size; snap.forEach(d => { list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;">${d.data().text} <button onclick="deleteOwlMessage('${d.id}')" style="color:red;">Sil</button></div>`; }); }); }

    window.switchAdminTab=(t, el)=>{ document.querySelectorAll('.tab-admin').forEach(e=>e.classList.remove('active')); el.classList.add('active'); ['adminPanelDashboard','adminPanelMessages','adminPanelHistory','adminPanelClan', 'adminPanelOwl', 'adminPanelCapsules'].forEach(x=>document.getElementById(x).classList.add('hidden')); if(t==='dashboard') document.getElementById('adminPanelDashboard').classList.remove('hidden'); else if(t==='messages') document.getElementById('adminPanelMessages').classList.remove('hidden'); else if(t==='history') document.getElementById('adminPanelHistory').classList.remove('hidden'); else if(t==='clan') document.getElementById('adminPanelClan').classList.remove('hidden'); else if(t==='owl') document.getElementById('adminPanelOwl').classList.remove('hidden'); else if(t==='capsules') document.getElementById('adminPanelCapsules').classList.remove('hidden'); };
    window.sendAdminMessage = async () => { const uid = document.getElementById('msgStudentSelect').value; const msg = document.getElementById('msgContent').value; if(!uid || !msg) return Swal.fire("Eksik", "", "warning"); await addDoc(collection(db,"messages"),{ toUid:uid, content:msg, read:false, type:'admin', createdAt:serverTimestamp() }); Swal.fire("GÃ¶nderildi", "", "success"); };
    window.addOwlMessage = async () => { const t=document.getElementById('newOwlMsg').value; if(t) await addDoc(collection(db,"owl_messages"),{text:t,createdAt:serverTimestamp()}); }; window.deleteOwlMessage = async(id)=>await deleteDoc(doc(db,"owl_messages",id));
    window.rejectRequest=async(c,id)=>await deleteDoc(doc(db,c,id)); window.approveClan=async(r,l,n,i)=>{const c=await addDoc(collection(db,"clans"),{name:n,icon:i,leader:l,memberCount:1,totalScore:0});await updateDoc(doc(db,"users",l),{clanId:c.id});await deleteDoc(doc(db,"clan_requests",r));}; window.approveMember=async(r,u,c)=>{await runTransaction(db,async(t)=>{const cd=(await t.get(doc(db,"clans",c))).data();const ud=(await t.get(doc(db,"users",u))).data();t.update(doc(db,"clans",c),{memberCount:(cd.memberCount||0)+1,totalScore:(cd.totalScore||0)+(ud.xp||0)});t.update(doc(db,"users",u),{clanId:c});t.delete(doc(db,"member_requests",r));});};
</script>
</body>
</html>